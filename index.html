<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
<title>7/D Sohbet + Altun.ai + Oyunlar</title>

<style>
* {
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  box-sizing: border-box;
}

html, body {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  overflow: hidden;
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
}

body {
 margin: 0;
 font-family: 'Segoe UI', Arial, sans-serif;
 background: black;
 color: white;
 overflow: hidden;
 position: fixed;
 width: 100%;
 height: 100%;
}

/* RGB arkaplan */
body::before {
 content: "";
 position: fixed;
 inset: 0;
 background: linear-gradient(45deg, red, blue, lime, red);
 background-size: 400% 400%;
 animation: rgb 12s linear infinite;
 opacity: .25;
 z-index: -1;
 pointer-events: none;
}

@keyframes rgb {
 0% { background-position: 0% 50% }
 50% { background-position: 100% 50% }
 100% { background-position: 0% 50% }
}

/* Login ekranƒ± */
#login {
 position: fixed;
 inset: 0;
 background: #020617;
 display: flex;
 flex-direction: column;
 justify-content: center;
 align-items: center;
 gap: 10px;
 z-index: 10;
}

#login input {
 height: 42px;
 width: 230px;
 border-radius: 10px;
 border: none;
 padding: 0 10px;
 font-size: 15px;
 -webkit-user-select: text;
 -moz-user-select: text;
 -ms-user-select: text;
 user-select: text;
}

#login input[type="password"] {
  font-family: monospace;
  -webkit-user-select: text;
  -moz-user-select: text;
  -ms-user-select: text;
  user-select: text;
}

#login input[type="file"] {
  padding: 8px;
  background: #1e293b;
  color: white;
}

#login button {
 height: 40px;
 padding: 0 14px;
 border-radius: 10px;
 border: none;
 background: #1e293b;
 color: white;
 cursor: pointer;
 pointer-events: auto;
}

#login-error {
 color: #ff4444;
 font-size: 14px;
 min-height: 20px;
}

/* Profil fotoƒürafƒ± preview */
#pfp-preview {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: #1e293b;
  margin-bottom: 10px;
  object-fit: cover;
  border: 3px solid #2563eb;
  display: none;
  pointer-events: none;
}

/* Men√º butonu */
#menu-btn {
 position: fixed;
 left: 10px;
 top: 10px;
 width: 45px;
 height: 45px;
 background: #020617;
 border: 2px solid #1e293b;
 border-radius: 10px;
 color: white;
 font-size: 24px;
 cursor: pointer;
 z-index: 100;
 display: flex;
 align-items: center;
 justify-content: center;
 transition: 0.3s;
 pointer-events: auto;
}

#menu-btn:hover {
 background: #2563eb;
 border-color: #2563eb;
}

/* Sidebar (Men√º) */
#sidebar {
 position: fixed;
 left: -250px;
 top: 0;
 bottom: 0;
 width: 250px;
 background: #020617;
 border-right: 2px solid #1e293b;
 padding: 70px 0 20px 0;
 z-index: 99;
 transition: left 0.3s ease;
 display: flex;
 flex-direction: column;
 overflow-y: auto;
}

#sidebar.open {
 left: 0;
}

#sidebar-header {
 padding: 15px;
 border-bottom: 1px solid #1e293b;
 margin-bottom: 20px;
}

#sidebar-header h3 {
 margin: 0;
 color: #00ffcc;
 font-size: 18px;
}

.sidebar-btn {
 width: 210px;
 margin: 10px 20px;
 padding: 15px;
 background: #1e293b;
 border: none;
 border-radius: 10px;
 color: white;
 cursor: pointer;
 font-size: 16px;
 transition: 0.3s;
 text-align: left;
 pointer-events: auto;
}

.sidebar-btn:hover {
 background: #2563eb;
}

.sidebar-btn.active {
 background: #2563eb;
 border-left: 4px solid #00ffcc;
}

/* Sidebar overlay */
#sidebar-overlay {
 position: fixed;
 inset: 0;
 background: rgba(0,0,0,0.5);
 z-index: 98;
 display: none;
 pointer-events: auto;
}

#sidebar-overlay.show {
 display: block;
}

/* Ana i√ßerik */
#main-content {
 position: absolute;
 left: 0;
 right: 0;
 top: 0;
 bottom: 0;
 background: transparent;
 overflow: hidden;
}

/* Sohbet ekranƒ± */
#chat-screen {
 height: 100%;
 display: flex;
 flex-direction: column;
 overflow: hidden;
}

#topbar {
 height: 55px;
 background: #020617;
 display: flex;
 align-items: center;
 justify-content: center;
 position: relative;
 flex-shrink: 0;
}

#admin-badge {
 position: absolute;
 left: 70px;
 background: #dc2626;
 color: white;
 padding: 4px 10px;
 border-radius: 20px;
 font-size: 12px;
 font-weight: bold;
 display: none;
 pointer-events: none;
}

#onlineBtn {
 position: absolute;
 right: 10px;
 pointer-events: auto;
}

#onlinePanel {
 position: fixed;
 top: 60px;
 left: 50%;
 transform: translateX(-50%);
 background: #020617;
 padding: 10px;
 border-radius: 12px;
 display: none;
 min-width: 200px;
 max-height: 250px;
 overflow-y: auto;
 z-index: 6;
 pointer-events: auto;
}

.userItem {
 padding: 8px;
 border-bottom: 1px solid #1e293b;
 font-size: 14px;
 display: flex;
 align-items: center;
 gap: 8px;
}

.userItem .user-pfp {
  width: 25px;
  height: 25px;
  border-radius: 50%;
  object-fit: cover;
  pointer-events: none;
}

.userItem .user-info {
  flex: 1;
}

.userItem .admin-actions {
 display: flex;
 gap: 5px;
 margin-left: auto;
}

.userItem .admin-actions button {
 padding: 2px 5px;
 font-size: 11px;
 background: #1e293b;
 color: white;
 border: none;
 border-radius: 3px;
 cursor: pointer;
 pointer-events: auto;
}

.userItem .admin-actions button:hover {
 background: #dc2626;
}

.userItem.banned {
 opacity: 0.5;
 text-decoration: line-through;
}

.userItem.muted {
 color: #ffaa00;
}

#chat {
 flex: 1;
 overflow-y: auto;
 padding: 10px;
 display: flex;
 flex-direction: column;
 gap: 8px;
 -webkit-overflow-scrolling: touch;
}

.msg {
 max-width: 70%;
 padding: 10px 14px;
 border-radius: 16px;
 font-size: 14px;
 line-height: 1.4;
 word-wrap: break-word;
 animation: fade .12s ease-out;
 position: relative;
}

.user { background: #1e293b; align-self: flex-start; border-bottom-left-radius: 4px; }
.me { background: #2563eb; align-self: flex-end; border-bottom-right-radius: 4px; }
.admin { background: #dc2626; align-self: flex-start; }

.msg-header {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 5px;
}

.msg-pfp {
  width: 25px;
  height: 25px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid currentColor;
  pointer-events: none;
}

.msg-username {
  font-weight: bold;
  font-size: 13px;
}

.msg.muted-message {
 opacity: 0.5;
 font-style: italic;
}

.msg .delete-btn {
 position: absolute;
 top: -5px;
 right: -5px;
 background: #dc2626;
 color: white;
 border: none;
 border-radius: 50%;
 width: 20px;
 height: 20px;
 font-size: 12px;
 cursor: pointer;
 display: none;
 pointer-events: auto;
}

.msg.admin .delete-btn {
 display: block;
}

.msg img {
 max-width: 180px;
 border-radius: 10px;
 margin-top: 5px;
 pointer-events: none;
}

@keyframes fade {
 from { opacity: .4; transform: translateY(3px) }
 to { opacity: 1 }
}

#inputBar {
 height: 70px;
 background: #020617;
 display: flex;
 align-items: center;
 gap: 6px;
 padding: 8px;
 flex-shrink: 0;
}

#text {
 flex: 1;
 height: 40px;
 border: none;
 border-radius: 10px;
 padding: 0 10px;
 font-size: 16px;
 -webkit-user-select: text;
 -moz-user-select: text;
 -ms-user-select: text;
 user-select: text;
}

#text:disabled {
 opacity: 0.5;
 background: #333;
}

#imgInput {
  pointer-events: auto;
}

/* Altun.ai ekranƒ± */
#altun-screen {
 height: 100%;
 display: flex;
 flex-direction: column;
 background: rgba(20,20,20,0.95);
 overflow: hidden;
}

#altun-header {
 padding: 18px;
 background: linear-gradient(90deg, #00ffcc, #0099ff);
 color: black;
 font-weight: bold;
 text-align: center;
 font-size: 20px;
 flex-shrink: 0;
}

#altun-messages {
 flex: 1;
 overflow-y: auto;
 padding: 15px;
 scroll-behavior: smooth;
 -webkit-overflow-scrolling: touch;
}

.altun-message {
 margin: 10px 0;
 padding: 10px 14px;
 border-radius: 14px;
 max-width: 75%;
 animation: popIn 0.2s ease;
}

@keyframes popIn {
 from { transform: scale(0.9); opacity: 0; }
 to { transform: scale(1); opacity: 1; }
}

.altun-user {
 background: #0099ff;
 margin-left: auto;
}

.altun-bot {
 background: #00c853;
 color: black;
}

.typing {
 display: inline-block;
 width: 40px;
}

.dot {
 animation: blink 1.4s infinite both;
}

.dot:nth-child(2) { animation-delay: .2s; }
.dot:nth-child(3) { animation-delay: .4s; }

@keyframes blink {
 0% { opacity: .2; }
 20% { opacity: 1; }
 100% { opacity: .2; }
}

#altun-input-area {
 display: flex;
 padding: 10px;
 background: #111;
 flex-shrink: 0;
}

#altun-input {
 flex: 1;
 padding: 12px;
 border-radius: 10px;
 border: none;
 outline: none;
 font-size: 14px;
 -webkit-user-select: text;
 -moz-user-select: text;
 -ms-user-select: text;
 user-select: text;
}

.altun-btn {
 margin-left: 10px;
 padding: 12px 16px;
 border: none;
 border-radius: 10px;
 background: linear-gradient(90deg, #00ffcc, #0099ff);
 cursor: pointer;
 font-weight: bold;
 pointer-events: auto;
}

/* Yƒ±lan Oyunu ekranƒ± - Geli≈ütirilmi≈ü */
#snake-screen {
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #0a2a0a, #051505);
  position: relative;
  overflow: hidden;
}

#snake-frame {
  width: 100%;
  height: 100%;
  border: none;
  background: transparent;
}

/* Satran√ß Oyunu */
#chess-screen {
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #0a0a1f, #1a1a3a);
  display: flex;
  flex-direction: column;
  padding: 20px;
  overflow: auto;
}

#chess-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding: 10px 20px;
  background: rgba(0,0,0,0.5);
  border-radius: 15px;
  border: 1px solid #00ffcc;
}

#chess-header h2 {
  color: #00ffcc;
  margin: 0;
}

#chess-header button {
  padding: 8px 20px;
  background: linear-gradient(90deg, #00ffcc, #0099ff);
  border: none;
  border-radius: 8px;
  color: black;
  font-weight: bold;
  cursor: pointer;
}

#chess-main {
  display: flex;
  gap: 20px;
  flex: 1;
  min-height: 0;
}

#chess-sidebar {
  width: 280px;
  background: rgba(0,0,0,0.8);
  border: 1px solid #00ffcc;
  border-radius: 15px;
  padding: 20px;
  overflow-y: auto;
}

#chess-sidebar h3 {
  color: #00ffcc;
  margin: 0 0 15px 0;
}

#rooms-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 20px;
}

.room-item {
  padding: 15px;
  background: rgba(255,255,255,0.05);
  border: 1px solid #00ffcc;
  border-radius: 10px;
  cursor: pointer;
  transition: 0.3s;
}

.room-item:hover {
  background: rgba(0,255,200,0.1);
}

.room-item .room-name {
  color: #00ffcc;
  font-weight: bold;
  margin-bottom: 5px;
}

.room-item .room-players {
  font-size: 13px;
  color: #888;
}

#chess-game-area {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  background: rgba(0,0,0,0.5);
  border: 1px solid #00ffcc;
  border-radius: 15px;
  padding: 20px;
}

#chess-canvas {
  width: min(70vh, 560px);
  height: min(70vh, 560px);
  border: 2px solid #00ffcc;
  border-radius: 10px;
  background: #f0d9b5;
  cursor: pointer;
}

/* Bekleme odasƒ± */
#waiting-area {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
}

.waiting-box {
  background: rgba(0,0,0,0.8);
  border: 2px solid #00ffcc;
  border-radius: 20px;
  padding: 40px;
  text-align: center;
  min-width: 400px;
}

.waiting-box h2 {
  color: #00ffcc;
  margin-bottom: 30px;
}

.player-slot {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  margin: 10px 0;
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
}

.player-slot .ready {
  color: #00ff00;
}

.player-slot .not-ready {
  color: #ff4444;
}

#ready-btn {
  margin-top: 30px;
  padding: 15px 40px;
  background: linear-gradient(90deg, #00ffcc, #0099ff);
  border: none;
  border-radius: 10px;
  color: black;
  font-weight: bold;
  font-size: 18px;
  cursor: pointer;
}

#turn-indicator {
  position: fixed;
  top: 100px;
  left: 50%;
  transform: translateX(-50%);
  padding: 10px 30px;
  border-radius: 30px;
  font-weight: bold;
  font-size: 18px;
  z-index: 100;
}

#turn-indicator.my-turn {
  background: linear-gradient(90deg, #00ffcc, #0099ff);
  color: black;
}

#turn-indicator.opponent-turn {
  background: linear-gradient(90deg, #ff4444, #cc0000);
  color: white;
}

#room-full-message {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,0,0,0.95);
  border: 3px solid #ff4444;
  border-radius: 30px;
  padding: 40px;
  text-align: center;
  z-index: 200;
  display: none;
}

#room-full-message button {
  margin-top: 20px;
  padding: 10px 30px;
  background: white;
  border: none;
  border-radius: 10px;
  color: #ff4444;
  font-weight: bold;
  cursor: pointer;
}

/* AFK uyarƒ± mesajƒ± */
#afk-warning {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #ffaa00;
  color: black;
  padding: 15px 25px;
  border-radius: 10px;
  font-weight: bold;
  z-index: 1000;
  animation: slideIn 0.3s ease;
  display: none;
  border: 2px solid #ff8800;
}

@keyframes slideIn {
  from { transform: translateX(100%); }
  to { transform: translateX(0); }
}

.hidden {
  display: none !important;
}

.mute-notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #ffaa00;
  color: black;
  padding: 10px 20px;
  border-radius: 10px;
  z-index: 200;
  animation: slideIn 0.3s ease;
}
</style>

<!-- Chess.js K√ºt√ºphanesi -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<!-- Firebase K√ºt√ºphaneleri -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>

<body>

<audio id="notify" src="TT.m4a"></audio>

<!-- Login Ekranƒ± -->
<div id="login">
 <img id="pfp-preview" src="" alt="Profil fotoƒürafƒ±">
 <input id="nameInput" placeholder="Kullanƒ±cƒ± adƒ±">
 <input type="password" id="codeInput" placeholder="Kod">
 <input type="file" id="pfpInput" accept="image/*" onchange="previewPFP()">
 <button onclick="enter()">Giri≈ü</button>
 <div id="login-error"></div>
</div>

<!-- AFK Uyarƒ± -->
<div id="afk-warning">‚ö†Ô∏è 2 dakika hareketsizsin! Yakƒ±nda atƒ±lacaksƒ±n...</div>

<!-- Men√º butonu -->
<button id="menu-btn" onclick="toggleMenu()">‚ò∞</button>

<!-- Sidebar overlay -->
<div id="sidebar-overlay" onclick="closeMenu()"></div>

<!-- Sidebar (Men√º) -->
<div id="sidebar">
  <div id="sidebar-header">
    <h3>MEN√ú</h3>
  </div>
  <button class="sidebar-btn active" onclick="switchScreen('chat')" id="btn-chat">üí¨ 7/D Sohbet</button>
  <button class="sidebar-btn" onclick="switchScreen('altun')" id="btn-altun">ü§ñ Altun.ai</button>
  <button class="sidebar-btn" onclick="switchScreen('chess')" id="btn-chess">‚ôüÔ∏è Satran√ß</button>
  <button class="sidebar-btn" onclick="switchScreen('snake')" id="btn-snake">üêç Ye≈üil Arena</button>
</div>

<!-- Ana ƒ∞√ßerik -->
<div id="main-content">
  
  <!-- Sohbet Ekranƒ± -->
  <div id="chat-screen">
    <div id="topbar">
      <div id="admin-badge">üëë ADMIN</div>
      <div>7/D Sohbet</div>
      <button id="onlineBtn" onclick="toggleOnline()">üë• Aktif</button>
    </div>

    <div id="onlinePanel"></div>

    <div id="chat"></div>

    <div id="inputBar">
      <input id="text" placeholder="Mesaj...">
      <input type="file" id="imgInput" accept="image/*,image/gif">
      <button onclick="send()">G√∂nder</button>
    </div>
  </div>

  <!-- Altun.ai Ekranƒ± -->
  <div id="altun-screen" class="hidden">
    <div id="altun-header">Altun.ai</div>
    <div id="altun-messages"></div>
    <div id="altun-input-area">
      <input id="altun-input" placeholder="Mesaj yaz..." />
      <button class="altun-btn" onclick="sendToAltun()">G√∂nder</button>
    </div>
  </div>

  <!-- Satran√ß Ekranƒ± -->
  <div id="chess-screen" class="hidden">
    <div id="chess-header">
      <h2>‚ôüÔ∏è SATRAN√á</h2>
      <div>
        <input type="text" id="new-room-name" placeholder="Oda adƒ±" style="padding:8px; border-radius:5px; border:1px solid #00ffcc; background:rgba(0,0,0,0.5); color:white; margin-right:10px;">
        <button onclick="createChessRoom()">Oda Olu≈ütur</button>
      </div>
    </div>
    
    <div id="chess-main">
      <div id="chess-sidebar">
        <h3>üìã Aktif Odalar</h3>
        <div id="rooms-list"></div>
      </div>
      
      <div id="chess-game-area">
        <div id="waiting-area">
          <div class="waiting-box">
            <h2 id="waiting-room-title">Bekleme Odasƒ±</h2>
            <div class="player-slot">
              <span>‚ö™ Beyaz: <span id="white-player">Bo≈ü</span></span>
              <span id="white-ready" class="not-ready">Hazƒ±r Deƒüil</span>
            </div>
            <div class="player-slot">
              <span>‚ö´ Siyah: <span id="black-player">Bo≈ü</span></span>
              <span id="black-ready" class="not-ready">Hazƒ±r Deƒüil</span>
            </div>
            <button id="ready-btn" onclick="toggleReady()">HAZIR OL</button>
          </div>
        </div>
        
        <canvas id="chess-canvas" width="560" height="560" style="display: none;"></canvas>
      </div>
    </div>
    
    <div id="turn-indicator" class="hidden"></div>
    <div id="room-full-message">
      <h2>‚ö†Ô∏è ODA DOLU</h2>
      <p>Bu oda ≈üu anda dolu.</p>
      <button onclick="closeFullRoomMessage()">Tamam</button>
    </div>
  </div>

  <!-- Yƒ±lan Oyunu Ekranƒ± - D√ºzeltilmi≈ü -->
  <div id="snake-screen" class="hidden">
    <iframe id="snake-frame" srcdoc='
<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üêç Ye≈üil Arena Yƒ±lan</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  user-select: none;
}

body { 
  margin:0; 
  overflow:hidden; 
  background: linear-gradient(135deg, #0a3a0a, #052005);
  font-family:"Segoe UI",Arial;
  color:white;
}

/* Joystick */
#joyBase {
  position:fixed; 
  bottom:30px; 
  left:30px; 
  width:180px; 
  height:180px; 
  border-radius:50%; 
  background:rgba(20, 40, 20, 0.9); 
  border:4px solid #6fbf6f; 
  backdrop-filter:blur(10px);
  z-index:100; 
  touch-action:none;
  box-shadow:0 0 30px #2a5a2a, inset 0 0 20px #3a7a3a;
}

#joyKnob { 
  position:absolute; 
  left:65px; 
  top:65px; 
  width:50px; 
  height:50px; 
  border-radius:50%; 
  background:radial-gradient(circle at 30% 30%, #8fdf8f, #4a8f4a);
  box-shadow:0 0 20px #afefaf;
  transition:0.03s;
  border:2px solid #cfefcf;
  cursor: pointer;
}

/* UI */
#ui {
  position:fixed;
  top:20px;
  left:20px;
  z-index:50;
  background:rgba(10, 30, 10, 0.95);
  backdrop-filter:blur(10px);
  padding:20px 30px;
  border-radius:20px;
  border:2px solid #6fbf6f;
  color:#cfefcf;
  box-shadow:0 0 30px #1a3a1a;
  font-size:16px;
  font-weight:bold;
  display: flex;
  gap: 30px;
}

#ui div {
  display: flex;
  align-items: center;
  gap: 8px;
}

#ui span {
  color: #afefaf;
  font-size: 18px;
}

/* Oda Paneli */
#roomPanel {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:rgba(5, 20, 5, 0.98);
  backdrop-filter:blur(20px);
  padding:50px;
  border-radius:40px;
  border:3px solid #6fbf6f;
  box-shadow:0 0 80px #1a4a1a;
  z-index:200;
  text-align:center;
  min-width:500px;
  transition:0.4s;
}

#roomPanel h1 {
  color:#8fdf8f;
  margin-bottom:30px;
  font-size:42px;
  text-shadow:0 0 20px #4a8f4a;
  letter-spacing:2px;
}

.roomInput {
  width:100%;
  padding:15px;
  margin:20px 0;
  border:none;
  border-radius:15px;
  background:rgba(30, 60, 30, 0.9);
  color:#cfefcf;
  font-size:18px;
  border:2px solid #4a8f4a;
  transition:0.3s;
  text-align:center;
}

.roomInput:focus {
  outline:none;
  border-color:#8fdf8f;
  box-shadow:0 0 30px #5a9f5a;
}

.roomBtn {
  background:linear-gradient(135deg, #2a6a2a, #1a4a1a);
  border:none;
  color:#cfefcf;
  padding:15px 30px;
  border-radius:15px;
  font-size:18px;
  font-weight:bold;
  margin:10px;
  cursor:pointer;
  transition:0.3s;
  border:2px solid #4a8f4a;
  min-width:150px;
}

.roomBtn:hover {
  background:linear-gradient(135deg, #3a7a3a, #2a5a2a);
  transform:scale(1.05);
  box-shadow:0 0 30px #4a8f4a;
}

#activePlayers {
  color:#afefaf;
  font-size:24px;
  font-weight:bold;
}

/* Speed Button */
#speedBtn { 
  position:fixed; 
  bottom:30px; 
  right:30px; 
  width:100px;
  height:100px;
  border-radius:50%; 
  background:linear-gradient(135deg, #2a6a2a, #1a4a1a);
  color:#cfefcf; 
  font-weight:bold; 
  font-size:28px;
  z-index:100; 
  user-select:none;
  border:4px solid #6fbf6f;
  box-shadow:0 0 40px #1a4a1a;
  cursor:pointer;
  transition:0.2s;
  display:flex;
  align-items:center;
  justify-content:center;
}

#speedBtn:active {
  transform:scale(0.95);
  background:linear-gradient(135deg, #3a8a3a, #2a6a2a);
}

/* Skor Tablosu */
#scores {
  position:fixed;
  top:20px;
  right:20px;
  background:rgba(10, 30, 10, 0.95);
  backdrop-filter:blur(10px);
  padding:20px;
  border-radius:20px;
  border:2px solid #6fbf6f;
  box-shadow:0 0 30px #1a3a1a;
  z-index:50;
  min-width:300px;
  max-height:500px;
  overflow-y:auto;
}

#scores h3 {
  margin:0 0 15px 0;
  color:#8fdf8f;
  text-align:center;
  font-size:24px;
}

.playerScore {
  padding:12px 15px;
  margin:8px 0;
  border-radius:12px;
  background:rgba(30, 60, 30, 0.6);
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:16px;
  border-left:4px solid #4a8f4a;
  transition:0.2s;
}

.playerScore.me {
  background:rgba(40, 80, 40, 0.9);
  border-left:4px solid #afefaf;
  box-shadow:0 0 15px #4a8f4a;
}

.playerScore .rank {
  font-weight:bold;
  color:#8fdf8f;
  margin-right:10px;
}

.playerScore .score {
  font-weight:bold;
  color:#cfefcf;
  background:rgba(0,0,0,0.3);
  padding:4px 10px;
  border-radius:20px;
}

/* Food Counter */
#foodCount {
  position:fixed;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(10, 30, 10, 0.95);
  backdrop-filter:blur(10px);
  padding:15px 40px;
  border-radius:50px;
  border:2px solid #6fbf6f;
  box-shadow:0 0 30px #1a4a1a;
  z-index:50;
  font-size:20px;
  color:#cfefcf;
  display:flex;
  align-items:center;
  gap:10px;
}

#foodCount span {
  color:#ef8f8f;
  font-size:24px;
}

#dead { 
  position:fixed; 
  top:50%; 
  left:50%; 
  transform:translate(-50%,-50%); 
  font-size:90px; 
  opacity:0; 
  transition:0.3s; 
  z-index:1000; 
  color:#ef6f6f;
  text-shadow:0 0 50px #af3f3f;
  font-weight:bold;
  pointer-events:none;
  white-space:nowrap;
  background:rgba(0,0,0,0.5);
  padding:30px 60px;
  border-radius:50px;
  border:3px solid #ef6f6f;
}

#serverStatus {
  position:fixed;
  bottom:20px;
  right:150px;
  background:rgba(20, 40, 20, 0.9);
  color:#8fdf8f;
  padding:8px 20px;
  border-radius:30px;
  font-size:14px;
  border:1px solid #4a8f4a;
  z-index:50;
  display:flex;
  align-items:center;
  gap:8px;
}

#serverStatus::before {
  content: "‚óè";
  color: #6fbf6f;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}
</style>

<!-- Firebase K√ºt√ºphaneleri -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160/build/three.min.js"></script>
</head>
<body>
<div id="dead">‚ò†Ô∏è √ñLD√úN ‚ò†Ô∏è</div>

<!-- Oda Paneli -->
<div id="roomPanel">
  <h1>üêç YE≈ûƒ∞L ARENA</h1>
  <input type="text" id="roomName" class="roomInput" placeholder="oda adƒ±" value="yesiloda">
  <div style="display:flex; gap:8px; justify-content:center;">
    <button class="roomBtn" onclick="joinRoom()">üéÆ OYNA</button>
    <button class="roomBtn" onclick="createRoom()">‚ú® YENƒ∞ ODA</button>
  </div>
  <div style="margin-top:20px; color:#8faf8f;">
    <span id="activePlayers" style="color:#afefaf;">0</span> oyuncu
  </div>
</div>

<!-- UI -->
<div id="ui">
  <div>üë§ <span id="playerId"></span></div>
  <div>üìè <span id="snakeLength">5</span></div>
  <div>‚ö° <span id="speedDisplay">Normal</span></div>
</div>

<div id="foodCount">üçé <span id="foodCountValue">3</span></div>

<div id="scores">
  <h3>üèÜ SKOR TABLOSU</h3>
  <div id="scoreList"></div>
</div>

<div id="joyBase">
  <div id="joyKnob"></div>
</div>

<div id="speedBtn">‚ö°</div>

<div id="serverStatus">Sunucu Baƒülƒ±</div>

<script>
// Firebase Config - AYNI API
const firebaseConfig = {
  apiKey: "AIzaSyBVMvgD3u-UT5dAk72pXqLub05qNPjqPW8",
  authDomain: "dsohbet.firebaseapp.com",
  databaseURL: "https://dsohbet-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dsohbet"
};

// Firebase'i ba≈ülat (ana uygulamadan baƒüƒ±msƒ±z)
let db;
try {
  firebase.initializeApp(firebaseConfig, "snakeApp");
  db = firebase.database(firebase.app("snakeApp"));
  console.log("Snake Firebase baƒülandƒ±");
} catch(e) {
  console.log("Snake Firebase baƒülantƒ± hatasƒ±:", e);
  // Alternatif: ana uygulamayƒ± kullan
  db = firebase.database();
}

// Oyuncu
const playerId = "oyuncu_" + Math.random().toString(36).slice(2,7);
document.getElementById("playerId").textContent = playerId.slice(0,6);

// Oda
let currentRoom = null;
let gameActive = false;

// THREE Scene
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0a1a0a);

const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0, 30, 40);
camera.lookAt(0,0,0);

const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;
renderer.setPixelRatio(window.devicePixelRatio);
document.body.appendChild(renderer.domElement);

// I≈üƒ±k
const ambientLight = new THREE.AmbientLight(0x2a3a2a);
scene.add(ambientLight);

const mainLight = new THREE.DirectionalLight(0xcfefcf, 1.2);
mainLight.position.set(10, 30, 20);
mainLight.castShadow = true;
mainLight.receiveShadow = true;
mainLight.shadow.mapSize.width = 1024;
mainLight.shadow.mapSize.height = 1024;
const d = 25;
mainLight.shadow.camera.left = -d;
mainLight.shadow.camera.right = d;
mainLight.shadow.camera.top = d;
mainLight.shadow.camera.bottom = -d;
mainLight.shadow.camera.near = 1;
mainLight.shadow.camera.far = 50;
scene.add(mainLight);

// Platform
const platformSize = 30;
const platformGeo = new THREE.BoxGeometry(platformSize, 0.5, platformSize);
const platformMat = new THREE.MeshStandardMaterial({ color: 0x1a3a1a });
const platform = new THREE.Mesh(platformGeo, platformMat);
platform.position.y = -0.25;
platform.receiveShadow = true;
scene.add(platform);

// Grid
const gridHelper = new THREE.GridHelper(platformSize, 20, 0x4a8f4a, 0x2a5a2a);
gridHelper.position.y = 0;
scene.add(gridHelper);

// Yƒ±ldƒ±zlar
const starsGeo = new THREE.BufferGeometry();
const starsCount = 300;
const starsPos = new Float32Array(starsCount * 3);
for(let i = 0; i < starsCount * 3; i += 3) {
  starsPos[i] = (Math.random() - 0.5) * 300;
  starsPos[i+1] = (Math.random() - 0.5) * 300;
  starsPos[i+2] = (Math.random() - 0.5) * 300;
}
starsGeo.setAttribute("position", new THREE.BufferAttribute(starsPos, 3));
const starsMat = new THREE.PointsMaterial({ color: 0x5a7f5a, size: 0.15 });
const stars = new THREE.Points(starsGeo, starsMat);
scene.add(stars);

// Elmalar
let foods = [];

function createApple() {
  const appleGroup = new THREE.Group();
  const bodyGeo = new THREE.SphereGeometry(0.6, 16, 16);
  const bodyMat = new THREE.MeshStandardMaterial({ color: 0xef6f6f });
  const body = new THREE.Mesh(bodyGeo, bodyMat);
  body.scale.set(1, 1.1, 0.9);
  appleGroup.add(body);
  
  const leafGeo = new THREE.ConeGeometry(0.15, 0.3, 6);
  const leafMat = new THREE.MeshStandardMaterial({ color: 0x5aaf5a });
  const leaf = new THREE.Mesh(leafGeo, leafMat);
  leaf.position.set(0, 0.8, 0);
  leaf.rotation.x = 0.3;
  appleGroup.add(leaf);
  
  return appleGroup;
}

for(let i = 0; i < 5; i++) {
  const apple = createApple();
  scene.add(apple);
  foods.push(apple);
}

// Yƒ±lan
let snake = [];
let meshes = [];
let dir = new THREE.Vector3(1, 0, 0);
let lastDir = new THREE.Vector3(1, 0, 0);
let speed = 1.8;
let normalSpeed = 1.8;
let fastSpeed = 3.2;
let alive = true;
let snakeLength = 5;

const deadText = document.getElementById("dead");

function spawnSnake() {
  snake = [];
  meshes.forEach(m => scene.remove(m));
  meshes = [];
  
  for(let i = 0; i < 5; i++) {
    const pos = new THREE.Vector3(-i * 1.0, 0.25, 0);
    snake.push(pos);
    
    const geometry = i === 0 
      ? new THREE.ConeGeometry(0.7, 1.2, 8)
      : new THREE.SphereGeometry(0.6, 16, 16);
    
    const material = new THREE.MeshStandardMaterial({ 
      color: i === 0 ? 0x8fdf8f : 0x5aaf5a
    });
    
    const segment = new THREE.Mesh(geometry, material);
    segment.castShadow = true;
    segment.receiveShadow = true;
    segment.position.copy(pos);
    
    if(i === 0) {
      const eyeGeo = new THREE.SphereGeometry(0.1, 6);
      const eyeMat = new THREE.MeshStandardMaterial({ color: 0x000000 });
      
      const eye1 = new THREE.Mesh(eyeGeo, eyeMat);
      eye1.position.set(0.25, 0.2, 0.45);
      segment.add(eye1);
      
      const eye2 = new THREE.Mesh(eyeGeo, eyeMat);
      eye2.position.set(-0.25, 0.2, 0.45);
      segment.add(eye2);
    }
    
    scene.add(segment);
    meshes.push(segment);
  }
  
  snakeLength = 5;
  updateUI();
}

spawnSnake();

// Diƒüer oyuncular
const others = {};

function updateUI() {
  document.getElementById("snakeLength").textContent = snakeLength;
  document.getElementById("speedDisplay").textContent = speed > normalSpeed + 0.5 ? "Hƒ±zlƒ±" : "Normal";
}

function die() {
  if(!alive || !gameActive) return;
  alive = false;
  deadText.style.opacity = 1;
  
  meshes.forEach(m => {
    m.material.color.setHex(0x8f5f5f);
  });
  
  if(currentRoom && db) {
    db.ref(`snake_rooms/${currentRoom}/players/${playerId}`).remove();
  }
  
  setTimeout(() => {
    deadText.style.opacity = 0;
    spawnSnake();
    alive = true;
  }, 1500);
}

// Joystick
const base = document.getElementById("joyBase");
const knob = document.getElementById("joyKnob");
let joyActive = false;

base.addEventListener("pointerdown", (e) => {
  joyActive = true;
  e.preventDefault();
});

window.addEventListener("pointerup", () => {
  joyActive = false;
  knob.style.left = "65px";
  knob.style.top = "65px";
});

window.addEventListener("pointermove", (e) => {
  if(!joyActive) return;
  
  const rect = base.getBoundingClientRect();
  const centerX = rect.left + rect.width/2;
  const centerY = rect.top + rect.height/2;
  
  let dx = e.clientX - centerX;
  let dy = e.clientY - centerY;
  
  const maxDist = 70;
  const dist = Math.sqrt(dx*dx + dy*dy);
  
  if(dist > maxDist) {
    dx = (dx / dist) * maxDist;
    dy = (dy / dist) * maxDist;
  }
  
  knob.style.left = (65 + dx) + "px";
  knob.style.top = (65 + dy) + "px";
  
  const angleRad = Math.atan2(dy, dx);
  const newDir = new THREE.Vector3(Math.cos(angleRad), 0, Math.sin(angleRad)).normalize();
  
  const dot = newDir.dot(lastDir);
  if (dot > -0.7) {
    dir.copy(newDir);
  }
});

// Speed butonu
const speedBtn = document.getElementById("speedBtn");
speedBtn.addEventListener("pointerdown", () => {
  speed = fastSpeed;
  updateUI();
});
speedBtn.addEventListener("pointerup", () => {
  speed = normalSpeed;
  updateUI();
});

function randomFoodPos() {
  const limit = 12;
  return {
    x: (Math.random() * limit * 2) - limit,
    z: (Math.random() * limit * 2) - limit
  };
}

// Oda fonksiyonlarƒ± - D√úZELTƒ∞LDƒ∞
window.joinRoom = function() {
  const roomName = document.getElementById("roomName").value.trim();
  if(!roomName) {
    alert("Oda adƒ± girin!");
    return;
  }
  
  if(!db) {
    alert("Firebase baƒülantƒ±sƒ± kurulamadƒ±!");
    return;
  }
  
  currentRoom = roomName;
  
  document.getElementById("roomPanel").style.opacity = "0";
  document.getElementById("roomPanel").style.pointerEvents = "none";
  
  setTimeout(() => {
    document.getElementById("roomPanel").style.display = "none";
  }, 300);
  
  gameActive = true;
  
  const roomRef = db.ref(`snake_rooms/${roomName}`);
  const playerRef = roomRef.child(`players/${playerId}`);
  
  // √ñnce room'u olu≈ütur
  roomRef.child("active").set(true);
  
  // Oyuncuyu ekle
  playerRef.set({
    x: snake[0].x,
    z: snake[0].z,
    length: snakeLength,
    lastUpdate: Date.now()
  });
  
  // Oyuncu √ßƒ±kƒ±nca sil
  playerRef.onDisconnect().remove();
  
  // Diƒüer oyuncularƒ± dinle
  roomRef.child("players").on("value", (snap) => {
    const data = snap.val() || {};
    
    const scoreList = document.getElementById("scoreList");
    scoreList.innerHTML = "";
    
    const sorted = Object.entries(data).sort((a, b) => (b[1].length || 0) - (a[1].length || 0));
    
    sorted.forEach(([id, d], i) => {
      const div = document.createElement("div");
      div.className = "playerScore";
      if(id === playerId) div.classList.add("me");
      div.innerHTML = `<span class="rank">#${i+1}</span> ${id.slice(0,5)} <span class="score">${d.length || 5}</span>`;
      scoreList.appendChild(div);
    });
    
    document.getElementById("activePlayers").textContent = Object.keys(data).length;
    
    // Diƒüer oyuncularƒ± g√ºncelle
    for(const id in data) {
      if(id === playerId) continue;
      
      if(!others[id]) {
        const mesh = new THREE.Mesh(
          new THREE.ConeGeometry(0.6, 1.1, 8),
          new THREE.MeshStandardMaterial({ color: 0x8faf8f })
        );
        mesh.castShadow = true;
        mesh.receiveShadow = true;
        scene.add(mesh);
        others[id] = mesh;
      }
      
      if(others[id]) {
        others[id].position.set(data[id].x, 0.3, data[id].z);
      }
    }
    
    for(const id in others) {
      if(!data[id]) {
        scene.remove(others[id]);
        delete others[id];
      }
    }
  });
  
  // Yemleri dinle
  roomRef.child("foods").on("value", (snap) => {
    let arr = snap.val();
    if(!arr) {
      arr = [randomFoodPos(), randomFoodPos(), randomFoodPos(), randomFoodPos(), randomFoodPos()];
      roomRef.child("foods").set(arr);
      return;
    }
    
    for(let i = 0; i < arr.length; i++) {
      if(arr[i] && foods[i]) {
        foods[i].position.set(arr[i].x, 0.5, arr[i].z);
      }
    }
    
    document.getElementById("foodCountValue").textContent = arr.length;
  });
};

window.createRoom = function() {
  document.getElementById("roomName").value = "oda_" + Math.random().toString(36).slice(2,8);
  joinRoom();
};

// Game Loop
let last = performance.now();
let moveAccumulator = 0;
const MOVE_INTERVAL = 0.18;
const BOUNDARY = 14;

function loop(now) {
  const dt = Math.min((now - last) / 1000, 0.1);
  last = now;
  
  if(alive && gameActive && currentRoom && db) {
    moveAccumulator += dt * speed;
    
    while(moveAccumulator > MOVE_INTERVAL) {
      moveAccumulator -= MOVE_INTERVAL;
      
      const head = snake[0].clone().add(dir.clone().multiplyScalar(0.9));
      
      if(Math.abs(head.x) > BOUNDARY || Math.abs(head.z) > BOUNDARY) {
        die();
        break;
      }
      
      if(!alive) break;
      
      snake.unshift(head);
      
      let ateFood = false;
      for(let i = 0; i < foods.length; i++) {
        if(head.distanceTo(foods[i].position) < 1.2) {
          snakeLength++;
          updateUI();
          
          const foodRef = db.ref(`snake_rooms/${currentRoom}/foods`);
          foodRef.once("value").then((snap) => {
            const foodsArr = snap.val() || [];
            if(foodsArr[i]) {
              foodsArr[i] = randomFoodPos();
              foodRef.set(foodsArr);
            }
          });
          
          ateFood = true;
          break;
        }
      }
      
      if(!ateFood) {
        snake.pop();
      }
      
      meshes.forEach((m, i) => {
        if(snake[i]) {
          m.position.copy(snake[i]);
          if(i === 0 && snake.length > 1) {
            m.lookAt(snake[1]);
          }
        }
      });
      
      lastDir.copy(dir);
      
      if(Math.random() < 0.2) {
        db.ref(`snake_rooms/${currentRoom}/players/${playerId}`).update({
          x: snake[0].x,
          z: snake[0].z,
          length: snakeLength,
          lastUpdate: Date.now()
        });
      }
    }
  }
  
  stars.rotation.y += 0.0002;
  
  if(snake.length > 0 && alive) {
    camera.position.x = snake[0].x * 0.3;
    camera.position.z = snake[0].z * 0.3 + 35;
    camera.position.y = 28;
    camera.lookAt(snake[0].x * 0.3, 2, snake[0].z * 0.3);
  }
  
  renderer.render(scene, camera);
  requestAnimationFrame(loop);
}

loop(last);

window.addEventListener("beforeunload", () => {
  if(currentRoom && db) {
    db.ref(`snake_rooms/${currentRoom}/players/${playerId}`).remove();
  }
});

window.addEventListener("resize", () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

setTimeout(() => {
  if(!currentRoom) joinRoom();
}, 500);
</script>
</body>
</html>
    '></iframe>
  </div>

</div>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBVMvgD3u-UT5dAk72pXqLub05qNPjqPW8",
  authDomain: "dsohbet.firebaseapp.com",
  databaseURL: "https://dsohbet-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dsohbet"
};

// Firebase'i ba≈ülat (ana uygulama)
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Altun.ai API
const API_KEY = "6f49a41b-ee0f-47f3-a4ea-05d3f4f373a7";

// Deƒüi≈ükenler
let username = "", role = "user", pfp = "";
let onlineRef;
let currentScreen = 'chat';
let mutedUsers = {};
let bannedUsers = {};
let chessCurrentRoom = null;
let chessPlayerColor = null;
let chess = null;
let selectedSquare = null;
let possibleMoves = [];
let isPlayerReady = false;
let roomListener = null;
let lastActivityTime = Date.now();
let afkKickTimer = null;
const AFK_WARNING = 90000; // 1.5 dakika
const AFK_LIMIT = 120000;   // 2 dakika

// Sayfa kaymasƒ±nƒ± engelle
document.body.addEventListener('touchmove', function(e) {
  if (!e.target.closest('#chat') && !e.target.closest('#altun-messages') && !e.target.closest('#onlinePanel') && !e.target.closest('#sidebar')) {
    e.preventDefault();
  }
}, { passive: false });

// Men√º fonksiyonlarƒ±
window.toggleMenu = function() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  sidebar.classList.toggle('open');
  overlay.classList.toggle('show');
}

window.closeMenu = function() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
}

// Ekran deƒüi≈ütirme
window.switchScreen = function(screen) {
  updateActivity();
  currentScreen = screen;
  
  document.getElementById('btn-chat').classList.remove('active');
  document.getElementById('btn-altun').classList.remove('active');
  document.getElementById('btn-chess').classList.remove('active');
  document.getElementById('btn-snake').classList.remove('active');
  document.getElementById('btn-' + screen).classList.add('active');
  
  document.getElementById('chat-screen').classList.add('hidden');
  document.getElementById('altun-screen').classList.add('hidden');
  document.getElementById('chess-screen').classList.add('hidden');
  document.getElementById('snake-screen').classList.add('hidden');
  
  document.getElementById(screen + '-screen').classList.remove('hidden');
  
  if (screen === 'altun') {
    loadAltunHistory();
  } else if (screen === 'chess') {
    initChess();
  }
  
  closeMenu();
}

// Profil fotoƒürafƒ± preview
window.previewPFP = function() {
  const file = document.getElementById('pfpInput').files[0];
  const preview = document.getElementById('pfp-preview');
  
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      preview.src = e.target.result;
      preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  }
}

// AFK kontrol√º
function startAfkMonitoring() {
  if (afkKickTimer) clearInterval(afkKickTimer);
  
  afkKickTimer = setInterval(() => {
    const afkTime = Date.now() - lastActivityTime;
    
    if (afkTime > AFK_WARNING && afkTime < AFK_LIMIT) {
      document.getElementById('afk-warning').style.display = 'block';
    } else if (afkTime >= AFK_LIMIT) {
      document.getElementById('afk-warning').style.display = 'none';
      
      if (onlineRef) {
        onlineRef.remove();
      }
      
      if (chessCurrentRoom) {
        leaveChessRoom();
      }
      
      alert('2 dakika hareketsiz kaldƒ±ƒüƒ±nƒ±z i√ßin oturumunuz sonlandƒ±rƒ±ldƒ±!');
      location.reload();
    }
  }, 1000);
}

function updateActivity() {
  lastActivityTime = Date.now();
  document.getElementById('afk-warning').style.display = 'none';
}

// T√ºm etkile≈üimleri izle
['mousedown', 'mousemove', 'keydown', 'touchstart', 'scroll', 'wheel'].forEach(eventType => {
  document.addEventListener(eventType, updateActivity);
});

// Giri≈ü fonksiyonu
window.enter = function() {
  username = document.getElementById('nameInput').value.trim();
  const code = document.getElementById('codeInput').value.trim();
  const errorDiv = document.getElementById('login-error');
  
  if (!username) {
    errorDiv.textContent = "ƒ∞sim girmelisin!";
    return;
  }

  const validCodes = ['deop', 'kmja', 'Alex'];
  if (!validCodes.includes(code)) {
    errorDiv.textContent = "Ge√ßersiz kod!";
    return;
  }

  if (code === "deop") {
    role = "admin";
    document.getElementById('admin-badge').style.display = 'block';
  } else {
    role = "user";
  }

  const file = document.getElementById('pfpInput').files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      pfp = e.target.result;
      setupPresence();
    };
    reader.readAsDataURL(file);
  } else {
    pfp = "https://via.placeholder.com/50/1e293b/ffffff?text=" + username.charAt(0).toUpperCase();
    setupPresence();
  }

  document.getElementById('login').style.display = "none";
  
  updateActivity();
  startAfkMonitoring();

  listenMessages();
  listenOnline();
}

// Online presence
function setupPresence() {
  onlineRef = db.ref("online/" + username);
  onlineRef.set({
    name: username,
    role: role,
    pfp: pfp,
    time: Date.now(),
    lastActive: Date.now()
  });
  
  setInterval(() => {
    if (onlineRef) {
      onlineRef.update({ lastActive: Date.now() });
    }
  }, 30000);
  
  onlineRef.onDisconnect().remove();
}

// Online listesi
function listenOnline() {
  db.ref("online").on('value', (snap) => {
    const onlinePanel = document.getElementById('onlinePanel');
    onlinePanel.innerHTML = "";
    
    const now = Date.now();
    
    snap.forEach(child => {
      const u = child.val();
      if (!u.lastActive || now - u.lastActive <= AFK_LIMIT) {
        const div = document.createElement("div");
        div.className = "userItem";
        
        const pfpImg = document.createElement("img");
        pfpImg.className = "user-pfp";
        pfpImg.src = u.pfp || "https://via.placeholder.com/50/1e293b/ffffff?text=" + u.name.charAt(0).toUpperCase();
        pfpImg.onerror = () => pfpImg.src = "https://via.placeholder.com/50/1e293b/ffffff?text=" + u.name.charAt(0).toUpperCase();
        
        const infoDiv = document.createElement("div");
        infoDiv.className = "user-info";
        infoDiv.textContent = u.name + (u.role === "admin" ? " (admin)" : "");
        
        div.appendChild(pfpImg);
        div.appendChild(infoDiv);
        
        onlinePanel.appendChild(div);
      }
    });
  });
}

// Mesajlarƒ± dinle
function listenMessages() {
  db.ref("messages").on('child_added', (snap) => {
    render(snap.val());
    document.getElementById('notify').play();
  });
}

// Mesaj g√∂nder
window.send = function() {
  updateActivity();
  
  if (bannedUsers[username] && bannedUsers[username] > Date.now()) {
    showNotification("Banlandƒ±nƒ±z! 10 dakika boyunca mesaj g√∂nderemezsiniz.");
    return;
  }
  
  if (mutedUsers[username] && mutedUsers[username] > Date.now()) {
    showNotification("Susturuldunuz! 10 dakika boyunca mesaj g√∂nderemezsiniz.");
    return;
  }
  
  const value = document.getElementById('text').value.trim();
  const file = document.getElementById('imgInput').files[0];

  if (!value && !file) return;

  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      db.ref("messages").push({
        name: username,
        role: role,
        pfp: pfp,
        text: value,
        img: e.target.result
      });
    };
    reader.readAsDataURL(file);
  } else {
    db.ref("messages").push({
      name: username,
      role: role,
      pfp: pfp,
      text: value
    });
  }

  document.getElementById('text').value = "";
  document.getElementById('imgInput').value = "";
}

// Mesaj render
function render(m) {
  const chat = document.getElementById('chat');
  const div = document.createElement("div");

  let cls = "msg user";
  if (m.name === username) cls = "msg me";
  if (m.role === "admin") cls = "msg admin";

  div.className = cls;
  
  const header = document.createElement("div");
  header.className = "msg-header";
  
  const pfpImg = document.createElement("img");
  pfpImg.className = "msg-pfp";
  pfpImg.src = m.pfp || "https://via.placeholder.com/50/1e293b/ffffff?text=" + m.name.charAt(0).toUpperCase();
  pfpImg.onerror = () => pfpImg.src = "https://via.placeholder.com/50/1e293b/ffffff?text=" + m.name.charAt(0).toUpperCase();
  
  const nameSpan = document.createElement("span");
  nameSpan.className = "msg-username";
  nameSpan.textContent = m.name;
  
  header.appendChild(pfpImg);
  header.appendChild(nameSpan);
  div.appendChild(header);
  
  const textDiv = document.createElement("div");
  textDiv.textContent = m.text || "";
  div.appendChild(textDiv);

  if (m.img) {
    const img = document.createElement("img");
    img.src = m.img;
    div.appendChild(img);
  }

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

// Online panel toggle
window.toggleOnline = function() {
  updateActivity();
  const panel = document.getElementById('onlinePanel');
  panel.style.display = panel.style.display === "block" ? "none" : "block";
}

// Admin fonksiyonlarƒ±
function muteUser(targetUser) {
  mutedUsers[targetUser] = Date.now() + 600000;
  showNotification(`${targetUser} 10 dakika susturuldu!`);
}

function banUser(targetUser) {
  bannedUsers[targetUser] = Date.now() + 600000;
  showNotification(`${targetUser} 10 dakika banlandƒ±!`);
}

function showNotification(text) {
  const notif = document.createElement('div');
  notif.className = 'mute-notification';
  notif.textContent = text;
  document.body.appendChild(notif);
  setTimeout(() => notif.remove(), 3000);
}

// Altun.ai fonksiyonlarƒ±
function loadAltunHistory() {
  const saved = localStorage.getItem("altun_chat_history");
  const messagesDiv = document.getElementById("altun-messages");
  if (saved) {
    messagesDiv.innerHTML = saved;
  } else {
    addAltunMessage("Merhaba! Ben Altun.ai. Size nasƒ±l yardƒ±mcƒ± olabilirim?", "altun-bot");
  }
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function saveAltunChat() {
  localStorage.setItem("altun_chat_history", document.getElementById("altun-messages").innerHTML);
}

function addAltunMessage(text, cls) {
  const div = document.createElement("div");
  div.className = "altun-message " + cls;
  div.textContent = text;
  document.getElementById("altun-messages").appendChild(div);
  document.getElementById("altun-messages").scrollTop = document.getElementById("altun-messages").scrollHeight;
  saveAltunChat();
}

function showAltunTyping() {
  const div = document.createElement("div");
  div.className = "altun-message altun-bot";
  div.innerHTML = `Bot yazƒ±yor <span class="typing">
    <span class="dot">.</span>
    <span class="dot">.</span>
    <span class="dot">.</span>
  </span>`;
  div.id = "altun-typing";
  document.getElementById("altun-messages").appendChild(div);
  document.getElementById("altun-messages").scrollTop = document.getElementById("altun-messages").scrollHeight;
}

function removeAltunTyping() {
  const t = document.getElementById("altun-typing");
  if (t) t.remove();
}

window.sendToAltun = async function() {
  updateActivity();
  const input = document.getElementById("altun-input");
  const text = input.value.trim();
  if (!text) return;

  addAltunMessage("Sen: " + text, "altun-user");
  input.value = "";

  showAltunTyping();

  try {
    const response = await fetch("https://api.sambanova.ai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${API_KEY}`
      },
      body: JSON.stringify({
        model: "Meta-Llama-3.1-8B-Instruct",
        messages: [
          { role: "user", content: text }
        ]
      })
    });

    const data = await response.json();
    removeAltunTyping();
    const reply = data.choices?.[0]?.message?.content || "Cevap alƒ±namadƒ±";
    addAltunMessage("Bot: " + reply, "altun-bot");

  } catch (err) {
    removeAltunTyping();
    addAltunMessage("Bot: Hata olu≈ütu", "altun-bot");
  }
}

// SATRAN√á FONKSƒ∞YONLARI
let chessCanvas, chessCtx;

function initChess() {
  chessCanvas = document.getElementById('chess-canvas');
  chessCtx = chessCanvas.getContext('2d');
  
  listenChessRooms();
  chessCanvas.addEventListener('click', (e) => {
    updateActivity();
    handleChessClick(e);
  });
}

function listenChessRooms() {
  db.ref('chessRooms').on('value', (snap) => {
    const rooms = snap.val() || {};
    displayRooms(rooms);
  });
}

function displayRooms(rooms) {
  const container = document.getElementById('rooms-list');
  container.innerHTML = '';
  
  Object.entries(rooms).forEach(([roomId, room]) => {
    const whitePlayer = room.white?.name || 'Bo≈ü';
    const blackPlayer = room.black?.name || 'Bo≈ü';
    
    const roomDiv = document.createElement('div');
    roomDiv.className = 'room-item';
    roomDiv.onclick = () => joinChessRoom(roomId, room);
    
    roomDiv.innerHTML = `
      <div class="room-name">${room.name || roomId}</div>
      <div class="room-players">‚ö™ ${whitePlayer} | ‚ö´ ${blackPlayer}</div>
    `;
    
    container.appendChild(roomDiv);
  });
}

window.createChessRoom = function() {
  updateActivity();
  const roomName = document.getElementById('new-room-name').value.trim();
  if (!roomName) {
    showNotification('Oda adƒ± girin!');
    return;
  }
  
  const roomId = 'chess_' + Date.now();
  const roomRef = db.ref(`chessRooms/${roomId}`);
  
  roomRef.set({
    name: roomName,
    white: null,
    black: null,
    gameStarted: false,
    fen: 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1',
    turn: 'w',
    createdBy: username,
    createdAt: Date.now(),
    lastActivity: Date.now()
  });
  
  document.getElementById('new-room-name').value = '';
};

window.joinChessRoom = function(roomId, room) {
  updateActivity();
  
  if (room.white && room.black) {
    document.getElementById('room-full-message').style.display = 'block';
    return;
  }
  
  if (chessCurrentRoom) {
    leaveChessRoom();
  }
  
  chessCurrentRoom = roomId;
  
  if (!room.white) {
    chessPlayerColor = 'white';
  } else {
    chessPlayerColor = 'black';
  }
  
  isPlayerReady = false;
  
  const playerData = {
    name: username,
    ready: false,
    lastActive: Date.now()
  };
  
  const roomRef = db.ref(`chessRooms/${roomId}`);
  if (chessPlayerColor === 'white') {
    roomRef.update({ white: playerData });
  } else {
    roomRef.update({ black: playerData });
  }
  
  roomRef.update({ lastActivity: Date.now() });
  
  if (roomListener) {
    roomRef.off('value', roomListener);
  }
  
  roomListener = roomRef.on('value', (snap) => {
    const roomData = snap.val();
    if (!roomData) return;
    
    document.getElementById('waiting-area').style.display = 'block';
    document.getElementById('chess-canvas').style.display = 'none';
    document.getElementById('turn-indicator').classList.add('hidden');
    
    document.getElementById('waiting-room-title').textContent = roomData.name;
    document.getElementById('white-player').textContent = roomData.white?.name || 'Bo≈ü';
    document.getElementById('black-player').textContent = roomData.black?.name || 'Bo≈ü';
    
    const whiteReady = document.getElementById('white-ready');
    const blackReady = document.getElementById('black-ready');
    
    if (roomData.white?.ready) {
      whiteReady.textContent = 'HAZIR';
      whiteReady.className = 'ready';
    } else {
      whiteReady.textContent = 'Hazƒ±r Deƒüil';
      whiteReady.className = 'not-ready';
    }
    
    if (roomData.black?.ready) {
      blackReady.textContent = 'HAZIR';
      blackReady.className = 'ready';
    } else {
      blackReady.textContent = 'Hazƒ±r Deƒüil';
      blackReady.className = 'not-ready';
    }
    
    const readyBtn = document.getElementById('ready-btn');
    readyBtn.textContent = isPlayerReady ? 'HAZIRDAN VAZGE√á' : 'HAZIR OL';
    
    if (roomData.white?.ready && roomData.black?.ready && !roomData.gameStarted) {
      startChessGame(roomId);
    }
    
    if (roomData.gameStarted) {
      document.getElementById('waiting-area').style.display = 'none';
      document.getElementById('chess-canvas').style.display = 'block';
      document.getElementById('turn-indicator').classList.remove('hidden');
      
      if (!chess) {
        chess = new Chess(roomData.fen);
      } else {
        chess.load(roomData.fen);
      }
      
      updateTurnIndicator();
      drawChessBoard();
    }
  });
  
  roomRef.onDisconnect().update({
    white: room.white?.name === username ? null : room.white,
    black: room.black?.name === username ? null : room.black
  });
}

window.toggleReady = function() {
  updateActivity();
  if (!chessCurrentRoom || !chessPlayerColor) return;
  
  isPlayerReady = !isPlayerReady;
  
  const roomRef = db.ref(`chessRooms/${chessCurrentRoom}`);
  if (chessPlayerColor === 'white') {
    roomRef.update({ 'white/ready': isPlayerReady, 'white/lastActive': Date.now() });
  } else {
    roomRef.update({ 'black/ready': isPlayerReady, 'black/lastActive': Date.now() });
  }
}

function startChessGame(roomId) {
  chess = new Chess();
  
  const roomRef = db.ref(`chessRooms/${roomId}`);
  roomRef.update({
    gameStarted: true,
    fen: chess.fen(),
    turn: 'w'
  });
}

function leaveChessRoom() {
  if (!chessCurrentRoom) return;
  
  const roomRef = db.ref(`chessRooms/${chessCurrentRoom}`);
  if (chessPlayerColor === 'white') {
    roomRef.update({ white: null });
  } else if (chessPlayerColor === 'black') {
    roomRef.update({ black: null });
  }
  
  if (roomListener) {
    roomRef.off('value', roomListener);
  }
  
  chessCurrentRoom = null;
  chessPlayerColor = null;
  chess = null;
  selectedSquare = null;
  possibleMoves = [];
  isPlayerReady = false;
}

function updateTurnIndicator() {
  if (!chess || !chessPlayerColor) return;
  
  const isMyTurn = (chess.turn() === 'w' && chessPlayerColor === 'white') || 
                   (chess.turn() === 'b' && chessPlayerColor === 'black');
  
  const indicator = document.getElementById('turn-indicator');
  if (isMyTurn) {
    indicator.textContent = 'SIRA SENDE';
    indicator.className = 'my-turn';
  } else {
    indicator.textContent = 'SIRA RAKƒ∞Bƒ∞NDE';
    indicator.className = 'opponent-turn';
  }
}

function getSquareName(row, col) {
  const letters = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
  return letters[col] + (8 - row);
}

function drawChessBoard() {
  if (!chess) return;
  
  const squareSize = 70;
  const board = chess.board();
  
  for (let row = 0; row < 8; row++) {
    for (let col = 0; col < 8; col++) {
      const x = col * squareSize;
      const y = row * squareSize;
      
      chessCtx.fillStyle = (row + col) % 2 === 0 ? '#f0d9b5' : '#b58863';
      chessCtx.fillRect(x, y, squareSize, squareSize);
      
      if (selectedSquare && selectedSquare.row === row && selectedSquare.col === col) {
        chessCtx.fillStyle = 'rgba(0, 255, 200, 0.4)';
        chessCtx.fillRect(x, y, squareSize, squareSize);
      }
      
      if (chess.in_check()) {
        const kingSquare = findKing(chess.turn());
        if (kingSquare && kingSquare.row === row && kingSquare.col === col) {
          chessCtx.fillStyle = 'rgba(255, 0, 0, 0.3)';
          chessCtx.fillRect(x, y, squareSize, squareSize);
        }
      }
      
      if (possibleMoves.some(m => m.to === getSquareName(row, col))) {
        chessCtx.beginPath();
        chessCtx.arc(x + squareSize/2, y + squareSize/2, 12, 0, 2 * Math.PI);
        chessCtx.fillStyle = 'rgba(0, 255, 0, 0.5)';
        chessCtx.fill();
      }
      
      const piece = board[row][col];
      if (piece) {
        const symbols = {
          'p': '‚ôü', 'n': '‚ôû', 'b': '‚ôù', 'r': '‚ôú', 'q': '‚ôõ', 'k': '‚ôö',
          'P': '‚ôô', 'N': '‚ôò', 'B': '‚ôó', 'R': '‚ôñ', 'Q': '‚ôï', 'K': '‚ôî'
        };
        
        chessCtx.font = 'bold 50px Arial';
        chessCtx.fillStyle = piece.color === 'w' ? 'white' : 'black';
        chessCtx.fillText(symbols[piece.type === 'p' ? (piece.color === 'w' ? 'P' : 'p') : 
                                    (piece.color === 'w' ? piece.type.toUpperCase() : piece.type)], 
                         x + 10, y + 55);
      }
    }
  }
}

function findKing(color) {
  const board = chess.board();
  for (let row = 0; row < 8; row++) {
    for (let col = 0; col < 8; col++) {
      const piece = board[row][col];
      if (piece && piece.type === 'k' && piece.color === color) {
        return { row, col };
      }
    }
  }
  return null;
}

function handleChessClick(e) {
  updateActivity();
  
  if (!chess || !chessCurrentRoom) return;
  
  const isMyTurn = (chess.turn() === 'w' && chessPlayerColor === 'white') || 
                   (chess.turn() === 'b' && chessPlayerColor === 'black');
  
  if (!isMyTurn) {
    showNotification('Sƒ±ra sende deƒüil!');
    return;
  }
  
  const rect = chessCanvas.getBoundingClientRect();
  const scaleX = chessCanvas.width / rect.width;
  const scaleY = chessCanvas.height / rect.height;
  
  const mouseX = (e.clientX - rect.left) * scaleX;
  const mouseY = (e.clientY - rect.top) * scaleY;
  
  const col = Math.floor(mouseX / 70);
  const row = Math.floor(mouseY / 70);
  
  if (row >= 0 && row < 8 && col >= 0 && col < 8) {
    const squareName = getSquareName(row, col);
    
    if (selectedSquare) {
      const move = {
        from: getSquareName(selectedSquare.row, selectedSquare.col),
        to: squareName,
        promotion: 'q'
      };
      
      const result = chess.move(move);
      
      if (result) {
        const roomRef = db.ref(`chessRooms/${chessCurrentRoom}`);
        roomRef.update({
          fen: chess.fen(),
          turn: chess.turn(),
          lastActivity: Date.now()
        });
        
        selectedSquare = null;
        possibleMoves = [];
        
        if (chess.in_check()) {
          showNotification('≈ûAH!');
        }
      } else {
        const piece = chess.board()[row][col];
        if (piece && ((piece.color === 'w' && chessPlayerColor === 'white') || 
                     (piece.color === 'b' && chessPlayerColor === 'black'))) {
          selectedSquare = { row, col };
          possibleMoves = chess.moves({ square: squareName, verbose: true });
        } else {
          selectedSquare = null;
          possibleMoves = [];
        }
      }
    } else {
      const piece = chess.board()[row][col];
      if (piece && ((piece.color === 'w' && chessPlayerColor === 'white') || 
                   (piece.color === 'b' && chessPlayerColor === 'black'))) {
        selectedSquare = { row, col };
        possibleMoves = chess.moves({ square: squareName, verbose: true });
      }
    }
    
    drawChessBoard();
    updateTurnIndicator();
  }
}

window.closeFullRoomMessage = function() {
  document.getElementById('room-full-message').style.display = 'none';
};

// Sayfa y√ºklendiƒüinde
window.onload = function() {
  switchScreen('chat');
}
</script>

</body>
</html>
