<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
<title>7/D Sohbet + Altun.ai + Satran√ß update(Yt shorts final boss)</title>

<style>
* {
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  box-sizing: border-box;
}

html, body {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  overflow: hidden;
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
}

body {
 margin: 0;
 font-family: Arial;
 background: black;
 color: white;
 overflow: hidden;
 position: fixed;
 width: 100%;
 height: 100%;
}

/* RGB arkaplan */
body::before {
 content: "";
 position: fixed;
 inset: 0;
 background: linear-gradient(45deg, red, blue, lime, red);
 background-size: 400% 400%;
 animation: rgb 12s linear infinite;
 opacity: .25;
 z-index: -1;
 pointer-events: none;
}

@keyframes rgb {
 0% { background-position: 0% 50% }
 50% { background-position: 100% 50% }
 100% { background-position: 0% 50% }
}

/* Login ekranƒ± */
#login {
 position: fixed;
 inset: 0;
 background: #020617;
 display: flex;
 flex-direction: column;
 justify-content: center;
 align-items: center;
 gap: 10px;
 z-index: 10;
}

#login input {
 height: 42px;
 width: 230px;
 border-radius: 10px;
 border: none;
 padding: 0 10px;
 font-size: 15px;
 -webkit-user-select: text;
 -moz-user-select: text;
 -ms-user-select: text;
 user-select: text;
}

#login input[type="password"] {
  font-family: monospace;
  -webkit-user-select: text;
  -moz-user-select: text;
  -ms-user-select: text;
  user-select: text;
}

#login input[type="file"] {
  padding: 8px;
  background: #1e293b;
  color: white;
}

#login button {
 height: 40px;
 padding: 0 14px;
 border-radius: 10px;
 border: none;
 background: #1e293b;
 color: white;
 cursor: pointer;
 pointer-events: auto;
}

#login-error {
 color: #ff4444;
 font-size: 14px;
 min-height: 20px;
}

/* Profil fotoƒürafƒ± preview */
#pfp-preview {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: #1e293b;
  margin-bottom: 10px;
  object-fit: cover;
  border: 3px solid #2563eb;
  display: none;
  pointer-events: none;
}

/* Men√º butonu */
#menu-btn {
 position: fixed;
 left: 10px;
 top: 10px;
 width: 45px;
 height: 45px;
 background: #020617;
 border: 2px solid #1e293b;
 border-radius: 10px;
 color: white;
 font-size: 24px;
 cursor: pointer;
 z-index: 100;
 display: flex;
 align-items: center;
 justify-content: center;
 transition: 0.3s;
 pointer-events: auto;
}

#menu-btn:hover {
 background: #2563eb;
 border-color: #2563eb;
}

/* Sidebar (Men√º) */
#sidebar {
 position: fixed;
 left: -250px;
 top: 0;
 bottom: 0;
 width: 250px;
 background: #020617;
 border-right: 2px solid #1e293b;
 padding: 70px 0 20px 0;
 z-index: 99;
 transition: left 0.3s ease;
 display: flex;
 flex-direction: column;
 overflow-y: auto;
}

#sidebar.open {
 left: 0;
}

#sidebar-header {
 padding: 15px;
 border-bottom: 1px solid #1e293b;
 margin-bottom: 20px;
}

#sidebar-header h3 {
 margin: 0;
 color: #00ffcc;
 font-size: 18px;
}

.sidebar-btn {
 width: 210px;
 margin: 10px 20px;
 padding: 15px;
 background: #1e293b;
 border: none;
 border-radius: 10px;
 color: white;
 cursor: pointer;
 font-size: 16px;
 transition: 0.3s;
 text-align: left;
 pointer-events: auto;
}

.sidebar-btn:hover {
 background: #2563eb;
}

.sidebar-btn.active {
 background: #2563eb;
 border-left: 4px solid #00ffcc;
}

/* Sidebar overlay */
#sidebar-overlay {
 position: fixed;
 inset: 0;
 background: rgba(0,0,0,0.5);
 z-index: 98;
 display: none;
 pointer-events: auto;
}

#sidebar-overlay.show {
 display: block;
}

/* Ana i√ßerik */
#main-content {
 position: absolute;
 left: 0;
 right: 0;
 top: 0;
 bottom: 0;
 background: transparent;
 overflow: hidden;
}

/* Sohbet ekranƒ± */
#chat-screen {
 height: 100%;
 display: flex;
 flex-direction: column;
 overflow: hidden;
}

#topbar {
 height: 55px;
 background: #020617;
 display: flex;
 align-items: center;
 justify-content: center;
 position: relative;
 flex-shrink: 0;
}

#admin-badge {
 position: absolute;
 left: 70px;
 background: #dc2626;
 color: white;
 padding: 4px 10px;
 border-radius: 20px;
 font-size: 12px;
 font-weight: bold;
 display: none;
 pointer-events: none;
}

#onlineBtn {
 position: absolute;
 right: 10px;
 pointer-events: auto;
}

#onlinePanel {
 position: fixed;
 top: 60px;
 left: 50%;
 transform: translateX(-50%);
 background: #020617;
 padding: 10px;
 border-radius: 12px;
 display: none;
 min-width: 200px;
 max-height: 250px;
 overflow-y: auto;
 z-index: 6;
 pointer-events: auto;
}

.userItem {
 padding: 8px;
 border-bottom: 1px solid #1e293b;
 font-size: 14px;
 display: flex;
 align-items: center;
 gap: 8px;
}

.userItem .user-pfp {
  width: 25px;
  height: 25px;
  border-radius: 50%;
  object-fit: cover;
  pointer-events: none;
}

.userItem .user-info {
  flex: 1;
}

.userItem .admin-actions {
 display: flex;
 gap: 5px;
 margin-left: auto;
}

.userItem .admin-actions button {
 padding: 2px 5px;
 font-size: 11px;
 background: #1e293b;
 color: white;
 border: none;
 border-radius: 3px;
 cursor: pointer;
 pointer-events: auto;
}

.userItem .admin-actions button:hover {
 background: #dc2626;
}

.userItem.banned {
 opacity: 0.5;
 text-decoration: line-through;
}

.userItem.muted {
 color: #ffaa00;
}

#chat {
 flex: 1;
 overflow-y: auto;
 padding: 10px;
 display: flex;
 flex-direction: column;
 gap: 8px;
 -webkit-overflow-scrolling: touch;
}

.msg {
 max-width: 70%;
 padding: 10px 14px;
 border-radius: 16px;
 font-size: 14px;
 line-height: 1.4;
 word-wrap: break-word;
 animation: fade .12s ease-out;
 position: relative;
}

.user { background: #1e293b; align-self: flex-start; border-bottom-left-radius: 4px; }
.me { background: #2563eb; align-self: flex-end; border-bottom-right-radius: 4px; }
.admin { background: #dc2626; align-self: flex-start; }

.msg-header {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 5px;
}

.msg-pfp {
  width: 25px;
  height: 25px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid currentColor;
  pointer-events: none;
}

.msg-username {
  font-weight: bold;
  font-size: 13px;
}

.msg.muted-message {
 opacity: 0.5;
 font-style: italic;
}

.msg .delete-btn {
 position: absolute;
 top: -5px;
 right: -5px;
 background: #dc2626;
 color: white;
 border: none;
 border-radius: 50%;
 width: 20px;
 height: 20px;
 font-size: 12px;
 cursor: pointer;
 display: none;
 pointer-events: auto;
}

.msg.admin .delete-btn {
 display: block;
}

.msg img {
 max-width: 180px;
 border-radius: 10px;
 margin-top: 5px;
 pointer-events: none;
}

@keyframes fade {
 from { opacity: .4; transform: translateY(3px) }
 to { opacity: 1 }
}

#inputBar {
 height: 70px;
 background: #020617;
 display: flex;
 align-items: center;
 gap: 6px;
 padding: 8px;
 flex-shrink: 0;
}

#text {
 flex: 1;
 height: 40px;
 border: none;
 border-radius: 10px;
 padding: 0 10px;
 font-size: 16px;
 -webkit-user-select: text;
 -moz-user-select: text;
 -ms-user-select: text;
 user-select: text;
}

#text:disabled {
 opacity: 0.5;
 background: #333;
}

#imgInput {
  pointer-events: auto;
}

/* Altun.ai ekranƒ± */
#altun-screen {
 height: 100%;
 display: flex;
 flex-direction: column;
 background: rgba(20,20,20,0.95);
 overflow: hidden;
}

#altun-header {
 padding: 18px;
 background: linear-gradient(90deg, #00ffcc, #0099ff);
 color: black;
 font-weight: bold;
 text-align: center;
 font-size: 20px;
 flex-shrink: 0;
}

#altun-messages {
 flex: 1;
 overflow-y: auto;
 padding: 15px;
 scroll-behavior: smooth;
 -webkit-overflow-scrolling: touch;
}

.altun-message {
 margin: 10px 0;
 padding: 10px 14px;
 border-radius: 14px;
 max-width: 75%;
 animation: popIn 0.2s ease;
}

@keyframes popIn {
 from { transform: scale(0.9); opacity: 0; }
 to { transform: scale(1); opacity: 1; }
}

.altun-user {
 background: #0099ff;
 margin-left: auto;
}

.altun-bot {
 background: #00c853;
 color: black;
}

.typing {
 display: inline-block;
 width: 40px;
}

.dot {
 animation: blink 1.4s infinite both;
}

.dot:nth-child(2) { animation-delay: .2s; }
.dot:nth-child(3) { animation-delay: .4s; }

@keyframes blink {
 0% { opacity: .2; }
 20% { opacity: 1; }
 100% { opacity: .2; }
}

#altun-input-area {
 display: flex;
 padding: 10px;
 background: #111;
 flex-shrink: 0;
}

#altun-input {
 flex: 1;
 padding: 12px;
 border-radius: 10px;
 border: none;
 outline: none;
 font-size: 14px;
 -webkit-user-select: text;
 -moz-user-select: text;
 -ms-user-select: text;
 user-select: text;
}

.altun-btn {
 margin-left: 10px;
 padding: 12px 16px;
 border: none;
 border-radius: 10px;
 background: linear-gradient(90deg, #00ffcc, #0099ff);
 cursor: pointer;
 font-weight: bold;
 pointer-events: auto;
}

/* Satran√ß Oyunu ekranƒ± */
#chess-screen {
 height: 100%;
 display: flex;
 background: linear-gradient(135deg, #0a0a1f, #1a1a3a);
 overflow: hidden;
 position: relative;
}

#chess-sidebar {
 width: 280px;
 background: rgba(0,0,0,0.8);
 backdrop-filter: blur(10px);
 border-right: 2px solid #00ffcc;
 display: flex;
 flex-direction: column;
 padding: 20px;
 overflow-y: auto;
}

#chess-sidebar h2 {
 color: #00ffcc;
 text-align: center;
 margin: 0 0 20px 0;
 text-shadow: 0 0 10px #00ffcc;
 font-size: 24px;
}

#create-room-section {
 margin-bottom: 30px;
 padding: 15px;
 background: rgba(255,255,255,0.05);
 border-radius: 10px;
 border: 1px solid #00ffcc;
}

#create-room-section h3 {
 color: #00ffcc;
 margin: 0 0 15px 0;
 font-size: 18px;
}

#create-room-section input {
 width: 100%;
 padding: 10px;
 margin-bottom: 10px;
 border-radius: 5px;
 border: 1px solid #00ffcc;
 background: rgba(0,0,0,0.5);
 color: white;
}

#create-room-section button {
 width: 100%;
 padding: 12px;
 background: linear-gradient(90deg, #00ffcc, #0099ff);
 border: none;
 border-radius: 5px;
 color: black;
 font-weight: bold;
 cursor: pointer;
 transition: 0.3s;
}

#create-room-section button:hover {
 transform: scale(1.02);
 box-shadow: 0 0 20px #00ffcc;
}

#rooms-list-section {
 flex: 1;
}

#rooms-list-section h3 {
 color: #00ffcc;
 margin: 0 0 15px 0;
 font-size: 18px;
}

#rooms-container {
 display: flex;
 flex-direction: column;
 gap: 10px;
}

.room-item {
 background: rgba(255,255,255,0.05);
 border: 1px solid #00ffcc;
 border-radius: 8px;
 padding: 12px;
 cursor: pointer;
 transition: 0.3s;
}

.room-item:hover {
 background: rgba(0,255,200,0.1);
 transform: translateX(5px);
}

.room-item.full {
 opacity: 0.5;
 cursor: not-allowed;
 border-color: #ff4444;
}

.room-item.full:hover {
 transform: none;
 background: rgba(255,68,68,0.1);
}

.room-name {
 font-weight: bold;
 color: #00ffcc;
 margin-bottom: 5px;
}

.room-info {
 display: flex;
 justify-content: space-between;
 font-size: 12px;
 color: #888;
}

.room-status {
 color: #00ffcc;
}

.room-status.full {
 color: #ff4444;
}

#chess-game-area {
 flex: 1;
 display: flex;
 justify-content: center;
 align-items: center;
 position: relative;
}

#chess-canvas {
 width: 560px;
 height: 560px;
 border: 3px solid #00ffcc;
 border-radius: 10px;
 box-shadow: 0 0 40px rgba(0,255,200,0.3);
 background: #f0d9b5;
}

#game-info {
 position: absolute;
 top: 20px;
 left: 320px;
 background: rgba(0,0,0,0.8);
 backdrop-filter: blur(10px);
 border: 2px solid #00ffcc;
 border-radius: 10px;
 padding: 15px;
 min-width: 200px;
}

#game-info h3 {
 margin: 0 0 10px 0;
 color: #00ffcc;
}

.player-info {
 display: flex;
 align-items: center;
 gap: 10px;
 margin: 5px 0;
 padding: 5px;
 background: rgba(255,255,255,0.05);
 border-radius: 5px;
}

.player-color {
 width: 20px;
 height: 20px;
 border-radius: 10px;
}

.player-color.white { background: white; box-shadow: 0 0 10px white; }
.player-color.black { background: black; border: 2px solid white; }

#turn-indicator {
 margin-top: 10px;
 padding: 8px;
 text-align: center;
 background: linear-gradient(90deg, #00ffcc, #0099ff);
 border-radius: 5px;
 color: black;
 font-weight: bold;
}

#room-full-message {
 position: fixed;
 top: 50%;
 left: 50%;
 transform: translate(-50%, -50%);
 background: rgba(255,68,68,0.9);
 backdrop-filter: blur(10px);
 border: 3px solid #ff4444;
 border-radius: 15px;
 padding: 30px;
 text-align: center;
 z-index: 200;
 box-shadow: 0 0 50px #ff4444;
 display: none;
}

#room-full-message h2 {
 color: white;
 margin: 0 0 10px 0;
 font-size: 28px;
}

#room-full-message p {
 color: white;
 margin-bottom: 20px;
}

#room-full-message button {
 padding: 10px 30px;
 background: white;
 border: none;
 border-radius: 5px;
 color: #ff4444;
 font-weight: bold;
 cursor: pointer;
}

input, button {
 outline: none;
}

.hidden {
 display: none !important;
}

.mute-notification {
 position: fixed;
 top: 20px;
 right: 20px;
 background: #ffaa00;
 color: black;
 padding: 10px 20px;
 border-radius: 10px;
 font-weight: bold;
 z-index: 200;
 animation: slideIn 0.3s ease;
 pointer-events: none;
}

@keyframes slideIn {
 from { transform: translateX(100%); }
 to { transform: translateX(0); }
}

/* Mobil dokunmatik d√ºzeltmeler */
input, textarea, button, [contenteditable] {
  -webkit-touch-callout: default;
  -webkit-user-select: text;
  -khtml-user-select: text;
  -moz-user-select: text;
  -ms-user-select: text;
  user-select: text;
}

/* Scrollbar stilleri */
::-webkit-scrollbar {
  width: 5px;
}

::-webkit-scrollbar-track {
  background: #1e293b;
}

::-webkit-scrollbar-thumb {
  background: #2563eb;
  border-radius: 5px;
}
</style>
</head>

<body>

<audio id="notify" src="TT.m4a"></audio>

<!-- Login Ekranƒ± -->
<div id="login">
 <img id="pfp-preview" src="" alt="Profil fotoƒürafƒ±">
 <input id="nameInput" placeholder="Kullanƒ±cƒ± adƒ±">
 <input type="password" id="codeInput" placeholder="Kod">
 <input type="file" id="pfpInput" accept="image/*" onchange="previewPFP()">
 <button onclick="enter()">Giri≈ü</button>
 <div id="login-error"></div>
</div>

<!-- Men√º butonu -->
<button id="menu-btn" onclick="toggleMenu()">‚ò∞</button>

<!-- Sidebar overlay -->
<div id="sidebar-overlay" onclick="closeMenu()"></div>

<!-- Sidebar (Men√º) -->
<div id="sidebar">
  <div id="sidebar-header">
    <h3>MEN√ú</h3>
  </div>
  <button class="sidebar-btn active" onclick="switchScreen('chat'); closeMenu()" id="btn-chat">üí¨ 7/D Sohbet</button>
  <button class="sidebar-btn" onclick="switchScreen('altun'); closeMenu()" id="btn-altun">ü§ñ Altun.ai</button>
  <button class="sidebar-btn" onclick="switchScreen('chess'); closeMenu()" id="btn-chess">‚ôüÔ∏è Multiplayer Satran√ß</button>
</div>

<!-- Ana ƒ∞√ßerik -->
<div id="main-content">
  
  <!-- Sohbet Ekranƒ± -->
  <div id="chat-screen">
    <div id="topbar">
      <div id="admin-badge">üëë ADMIN</div>
      <div>7/D Sohbet</div>
      <button id="onlineBtn" onclick="toggleOnline()">üë• Aktif</button>
    </div>

    <div id="onlinePanel"></div>

    <div id="chat"></div>

    <div id="inputBar">
      <input id="text" placeholder="Mesaj...">
      <input type="file" id="imgInput" accept="image/*,image/gif">
      <button onclick="send()">G√∂nder</button>
    </div>
  </div>

  <!-- Altun.ai Ekranƒ± -->
  <div id="altun-screen" class="hidden">
    <div id="altun-header">Altun.ai</div>
    <div id="altun-messages"></div>
    <div id="altun-input-area">
      <input id="altun-input" placeholder="Mesaj yaz..." />
      <button class="altun-btn" onclick="sendToAltun()">G√∂nder</button>
    </div>
  </div>

  <!-- Satran√ß Oyunu Ekranƒ± -->
  <div id="chess-screen" class="hidden">
    <div id="chess-sidebar">
      <h2>‚ôüÔ∏è SATRAN√á ODALARI</h2>
      
      <div id="create-room-section">
        <h3>‚ûï Oda Olu≈ütur</h3>
        <input type="text" id="new-room-name" placeholder="Oda adƒ±" maxlength="20">
        <button onclick="createChessRoom()">Oda Olu≈ütur</button>
      </div>
      
      <div id="rooms-list-section">
        <h3>üìã Aktif Odalar</h3>
        <div id="rooms-container"></div>
      </div>
    </div>
    
    <div id="chess-game-area">
      <canvas id="chess-canvas" width="560" height="560"></canvas>
      
      <div id="game-info" style="display: none;">
        <h3>Oda: <span id="current-room-name"></span></h3>
        <div class="player-info">
          <div class="player-color white"></div>
          <span id="white-player">Bo≈ü</span>
        </div>
        <div class="player-info">
          <div class="player-color black"></div>
          <span id="black-player">Bo≈ü</span>
        </div>
        <div id="turn-indicator">Beyaz'ƒ±n Sƒ±rasƒ±</div>
      </div>
    </div>
    
    <!-- Oda Dolu Uyarƒ±sƒ± -->
    <div id="room-full-message">
      <h2>‚ö†Ô∏è ODA DOLU</h2>
      <p>Bu oda ≈üu anda dolu. Ba≈üka bir oda se√ßin veya yeni oda olu≈üturun.</p>
      <button onclick="closeFullRoomMessage()">Tamam</button>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { 
 getDatabase, ref, push, onChildAdded, set,
 onValue, onDisconnect, update, remove
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
 apiKey: "AIzaSyBVMvgD3u-UT5dAk72pXqLub05qNPjqPW8",
 authDomain: "dsohbet.firebaseapp.com",
 databaseURL: "https://dsohbet-default-rtdb.europe-west1.firebasedatabase.app",
 projectId: "dsohbet"
};

const app = initializeApp(firebaseConfig);
window.db = getDatabase(app);
window.ref = ref;
window.push = push;
window.onChildAdded = onChildAdded;
window.set = set;
window.onValue = onValue;
window.onDisconnect = onDisconnect;
window.update = update;
window.remove = remove;
</script>

<script>
// Altun.ai API
const API_KEY = "6f49a41b-ee0f-47f3-a4ea-05d3f4f373a7";

// Deƒüi≈ükenler
let username = "", role = "user", pfp = "";
let onlineRef;
let currentScreen = 'chat';
let mutedUsers = {};
let bannedUsers = {};
let currentRoom = null;
let playerColor = null;
let chessGame = null;

// Sayfa kaymasƒ±nƒ± engelle
document.body.addEventListener('touchmove', function(e) {
  if (!e.target.closest('#chat') && !e.target.closest('#altun-messages') && !e.target.closest('#onlinePanel') && !e.target.closest('#sidebar')) {
    e.preventDefault();
  }
}, { passive: false });

// Profil fotoƒürafƒ± preview
window.previewPFP = function() {
  const file = document.getElementById('pfpInput').files[0];
  const preview = document.getElementById('pfp-preview');
  
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      preview.src = e.target.result;
      preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
  }
}

// Men√º fonksiyonlarƒ±
window.toggleMenu = function() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  sidebar.classList.toggle('open');
  overlay.classList.toggle('show');
}

window.closeMenu = function() {
  const sidebar = document.getElementById('sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
}

// Ekran deƒüi≈ütirme
window.switchScreen = function(screen) {
  currentScreen = screen;
  
  document.getElementById('btn-chat').classList.remove('active');
  document.getElementById('btn-altun').classList.remove('active');
  document.getElementById('btn-chess').classList.remove('active');
  document.getElementById('btn-' + screen).classList.add('active');
  
  if (screen === 'chat') {
    document.getElementById('chat-screen').classList.remove('hidden');
    document.getElementById('altun-screen').classList.add('hidden');
    document.getElementById('chess-screen').classList.add('hidden');
  } else if (screen === 'altun') {
    document.getElementById('chat-screen').classList.add('hidden');
    document.getElementById('altun-screen').classList.remove('hidden');
    document.getElementById('chess-screen').classList.add('hidden');
    loadAltunHistory();
  } else if (screen === 'chess') {
    document.getElementById('chat-screen').classList.add('hidden');
    document.getElementById('altun-screen').classList.add('hidden');
    document.getElementById('chess-screen').classList.remove('hidden');
    initChessScreen();
  }
}

// Altun.ai fonksiyonlarƒ±
function loadAltunHistory() {
  const saved = localStorage.getItem("altun_chat_history");
  const messagesDiv = document.getElementById("altun-messages");
  if (saved) {
    messagesDiv.innerHTML = saved;
  } else {
    addAltunMessage("Merhaba! Ben Altun.ai. Size nasƒ±l yardƒ±mcƒ± olabilirim?", "altun-bot");
  }
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function saveAltunChat() {
  localStorage.setItem("altun_chat_history", document.getElementById("altun-messages").innerHTML);
}

function addAltunMessage(text, cls) {
  const div = document.createElement("div");
  div.className = "altun-message " + cls;
  div.textContent = text;
  document.getElementById("altun-messages").appendChild(div);
  document.getElementById("altun-messages").scrollTop = document.getElementById("altun-messages").scrollHeight;
  saveAltunChat();
}

function showAltunTyping() {
  const div = document.createElement("div");
  div.className = "altun-message altun-bot";
  div.innerHTML = `Bot yazƒ±yor <span class="typing">
    <span class="dot">.</span>
    <span class="dot">.</span>
    <span class="dot">.</span>
  </span>`;
  div.id = "altun-typing";
  document.getElementById("altun-messages").appendChild(div);
  document.getElementById("altun-messages").scrollTop = document.getElementById("altun-messages").scrollHeight;
}

function removeAltunTyping() {
  const t = document.getElementById("altun-typing");
  if (t) t.remove();
}

window.sendToAltun = async function() {
  const input = document.getElementById("altun-input");
  const text = input.value.trim();
  if (!text) return;

  addAltunMessage("Sen: " + text, "altun-user");
  input.value = "";

  showAltunTyping();

  try {
    const response = await fetch("https://api.sambanova.ai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${API_KEY}`
      },
      body: JSON.stringify({
        model: "Meta-Llama-3.1-8B-Instruct",
        messages: [
          { role: "user", content: text }
        ]
      })
    });

    const data = await response.json();
    removeAltunTyping();
    const reply = data.choices?.[0]?.message?.content || "Cevap alƒ±namadƒ±";
    addAltunMessage("Bot: " + reply, "altun-bot");

  } catch (err) {
    removeAltunTyping();
    addAltunMessage("Bot: Hata olu≈ütu", "altun-bot");
  }
}

// Giri≈ü fonksiyonu
window.enter = function() {
  username = document.getElementById('nameInput').value.trim();
  const code = document.getElementById('codeInput').value.trim();
  const errorDiv = document.getElementById('login-error');
  
  if (!username) {
    errorDiv.textContent = "ƒ∞sim girmelisin!";
    return;
  }

  const validCodes = ['deop', 'kmja', 'Alex'];
  if (!validCodes.includes(code)) {
    errorDiv.textContent = "Ge√ßersiz kod!";
    return;
  }

  if (code === "deop") {
    role = "admin";
    document.getElementById('admin-badge').style.display = 'block';
  } else {
    role = "user";
  }

  const file = document.getElementById('pfpInput').files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      pfp = e.target.result;
      setupPresence();
    };
    reader.readAsDataURL(file);
  } else {
    pfp = "https://via.placeholder.com/50/1e293b/ffffff?text=" + username.charAt(0).toUpperCase();
    setupPresence();
  }

  document.getElementById('login').style.display = "none";

  listenMessages();
  listenOnline();
  
  document.getElementById("altun-input").addEventListener("keydown", e => {
    if (e.key === "Enter") sendToAltun();
  });
}

function setupPresence() {
  onlineRef = ref(db, "online/" + username);
  set(onlineRef, {
    name: username,
    role: role,
    pfp: pfp,
    time: Date.now()
  });
  onDisconnect(onlineRef).remove();
}

function listenOnline() {
  onValue(ref(db, "online"), snap => {
    const onlinePanel = document.getElementById('onlinePanel');
    onlinePanel.innerHTML = "";
    snap.forEach(child => {
      const u = child.val();
      const div = document.createElement("div");
      div.className = "userItem";
      
      const pfpImg = document.createElement("img");
      pfpImg.className = "user-pfp";
      pfpImg.src = u.pfp || "https://via.placeholder.com/50/1e293b/ffffff?text=" + u.name.charAt(0).toUpperCase();
      pfpImg.onerror = () => pfpImg.src = "https://via.placeholder.com/50/1e293b/ffffff?text=" + u.name.charAt(0).toUpperCase();
      
      const infoDiv = document.createElement("div");
      infoDiv.className = "user-info";
      infoDiv.textContent = u.name + (u.role === "admin" ? " (admin)" : "");
      
      div.appendChild(pfpImg);
      div.appendChild(infoDiv);
      
      if (role === "admin" && u.name !== username) {
        const actions = document.createElement("div");
        actions.className = "admin-actions";
        
        const muteBtn = document.createElement("button");
        muteBtn.textContent = "üîá";
        muteBtn.title = "10 dk sustur";
        muteBtn.onclick = () => muteUser(u.name);
        
        const banBtn = document.createElement("button");
        banBtn.textContent = "üö´";
        banBtn.title = "10 dk banla";
        banBtn.onclick = () => banUser(u.name);
        
        actions.appendChild(muteBtn);
        actions.appendChild(banBtn);
        div.appendChild(actions);
      }
      
      onlinePanel.appendChild(div);
    });
  });
}

function muteUser(targetUser) {
  mutedUsers[targetUser] = Date.now() + 600000;
  showNotification(`${targetUser} 10 dakika susturuldu!`);
}

function banUser(targetUser) {
  bannedUsers[targetUser] = Date.now() + 600000;
  showNotification(`${targetUser} 10 dakika banlandƒ±!`);
}

function showNotification(text) {
  const notif = document.createElement('div');
  notif.className = 'mute-notification';
  notif.textContent = text;
  document.body.appendChild(notif);
  setTimeout(() => notif.remove(), 3000);
}

function listenMessages() {
  onChildAdded(ref(db, "messages"), snap => {
    render(snap.val());
    document.getElementById('notify').play();
  });
}

window.send = function() {
  if (bannedUsers[username] && bannedUsers[username] > Date.now()) {
    showNotification("Banlandƒ±nƒ±z! 10 dakika boyunca mesaj g√∂nderemezsiniz.");
    return;
  }
  
  if (mutedUsers[username] && mutedUsers[username] > Date.now()) {
    showNotification("Susturuldunuz! 10 dakika boyunca mesaj g√∂nderemezsiniz.");
    return;
  }
  
  const value = document.getElementById('text').value.trim();
  const file = document.getElementById('imgInput').files[0];

  if (!value && !file) return;

  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      push(ref(db, "messages"), {
        name: username,
        role: role,
        pfp: pfp,
        text: value,
        img: e.target.result
      });
    };
    reader.readAsDataURL(file);
  } else {
    push(ref(db, "messages"), {
      name: username,
      role: role,
      pfp: pfp,
      text: value
    });
  }

  document.getElementById('text').value = "";
  document.getElementById('imgInput').value = "";
}

function render(m) {
  const chat = document.getElementById('chat');
  const div = document.createElement("div");

  let cls = "msg user";
  if (m.name === username) cls = "msg me";
  if (m.role === "admin") cls = "msg admin";

  div.className = cls;
  
  const header = document.createElement("div");
  header.className = "msg-header";
  
  const pfpImg = document.createElement("img");
  pfpImg.className = "msg-pfp";
  pfpImg.src = m.pfp || "https://via.placeholder.com/50/1e293b/ffffff?text=" + m.name.charAt(0).toUpperCase();
  pfpImg.onerror = () => pfpImg.src = "https://via.placeholder.com/50/1e293b/ffffff?text=" + m.name.charAt(0).toUpperCase();
  
  const nameSpan = document.createElement("span");
  nameSpan.className = "msg-username";
  nameSpan.textContent = m.name;
  
  header.appendChild(pfpImg);
  header.appendChild(nameSpan);
  div.appendChild(header);
  
  const textDiv = document.createElement("div");
  textDiv.textContent = m.text || "";
  div.appendChild(textDiv);

  if (m.img) {
    const img = document.createElement("img");
    img.src = m.img;
    div.appendChild(img);
  }

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

window.toggleOnline = function() {
  const panel = document.getElementById('onlinePanel');
  panel.style.display = panel.style.display === "block" ? "none" : "block";
}

/* SATRAN√á OYUNU */
let chessCanvas, chessCtx;
let selectedPiece = null;
let possibleMoves = [];

// Satran√ß tahtasƒ± ba≈ülangƒ±√ß dizilimi
const initialBoard = [
  ['‚ôú', '‚ôû', '‚ôù', '‚ôõ', '‚ôö', '‚ôù', '‚ôû', '‚ôú'],
  ['‚ôü', '‚ôü', '‚ôü', '‚ôü', '‚ôü', '‚ôü', '‚ôü', '‚ôü'],
  ['', '', '', '', '', '', '', ''],
  ['', '', '', '', '', '', '', ''],
  ['', '', '', '', '', '', '', ''],
  ['', '', '', '', '', '', '', ''],
  ['‚ôô', '‚ôô', '‚ôô', '‚ôô', '‚ôô', '‚ôô', '‚ôô', '‚ôô'],
  ['‚ôñ', '‚ôò', '‚ôó', '‚ôï', '‚ôî', '‚ôó', '‚ôò', '‚ôñ']
];

function initChessScreen() {
  chessCanvas = document.getElementById('chess-canvas');
  chessCtx = chessCanvas.getContext('2d');
  
  // Oda listesini dinle
  listenChessRooms();
  
  // Canvas tƒ±klama olayƒ±
  chessCanvas.addEventListener('click', handleChessClick);
}

function listenChessRooms() {
  onValue(ref(db, 'chessRooms'), (snap) => {
    const rooms = snap.val() || {};
    displayRooms(rooms);
  });
}

function displayRooms(rooms) {
  const container = document.getElementById('rooms-container');
  container.innerHTML = '';
  
  Object.entries(rooms).forEach(([roomId, room]) => {
    const playerCount = (room.white ? 1 : 0) + (room.black ? 1 : 0);
    const isFull = playerCount >= 2;
    
    const roomDiv = document.createElement('div');
    roomDiv.className = `room-item ${isFull ? 'full' : ''}`;
    roomDiv.onclick = () => joinChessRoom(roomId, isFull);
    
    roomDiv.innerHTML = `
      <div class="room-name">${room.name || roomId}</div>
      <div class="room-info">
        <span>${playerCount}/2 Oyuncu</span>
        <span class="room-status ${isFull ? 'full' : ''}">${isFull ? 'DOLU' : 'Aktif'}</span>
      </div>
    `;
    
    container.appendChild(roomDiv);
  });
}

window.createChessRoom = function() {
  const roomName = document.getElementById('new-room-name').value.trim();
  if (!roomName) {
    showNotification('Oda adƒ± girin!');
    return;
  }
  
  const roomId = 'room_' + Date.now();
  const roomRef = ref(db, `chessRooms/${roomId}`);
  
  set(roomRef, {
    name: roomName,
    white: null,
    black: null,
    board: initialBoard,
    turn: 'white',
    createdAt: Date.now()
  });
  
  document.getElementById('new-room-name').value = '';
  showNotification('Oda olu≈üturuldu!');
};

window.joinChessRoom = function(roomId, isFull) {
  if (isFull) {
    document.getElementById('room-full-message').style.display = 'block';
    return;
  }
  
  // √ñnceki odadan ayrƒ±l
  if (currentRoom) {
    leaveChessRoom();
  }
  
  currentRoom = roomId;
  
  const roomRef = ref(db, `chessRooms/${roomId}`);
  onValue(roomRef, (snap) => {
    const room = snap.val();
    if (!room) return;
    
    // Oyuncu rengini belirle
    if (!room.white) {
      playerColor = 'white';
      update(roomRef, { white: username });
    } else if (!room.black && room.white !== username) {
      playerColor = 'black';
      update(roomRef, { black: username });
    } else if (room.white === username) {
      playerColor = 'white';
    } else if (room.black === username) {
      playerColor = 'black';
    }
    
    // Oda bilgilerini g√∂ster
    document.getElementById('game-info').style.display = 'block';
    document.getElementById('current-room-name').textContent = room.name || roomId;
    document.getElementById('white-player').textContent = room.white || 'Bo≈ü';
    document.getElementById('black-player').textContent = room.black || 'Bo≈ü';
    
    // Sƒ±ra g√∂stergesini g√ºncelle
    const turnText = room.turn === 'white' ? 'Beyaz' : 'Siyah';
    document.getElementById('turn-indicator').textContent = 
      `${turnText}'ƒ±n Sƒ±rasƒ± ${room.turn === playerColor ? '(Sen)' : ''}`;
    
    // Tahtayƒ± √ßiz
    drawChessBoard(room.board || initialBoard, room);
  });
  
  // √áƒ±kƒ±≈üta odadan ayrƒ±l
  onDisconnect(roomRef).update({
    white: roomRef.white === username ? null : roomRef.white,
    black: roomRef.black === username ? null : roomRef.black
  });
};

function leaveChessRoom() {
  if (!currentRoom) return;
  
  const roomRef = ref(db, `chessRooms/${currentRoom}`);
  if (playerColor === 'white') {
    update(roomRef, { white: null });
  } else if (playerColor === 'black') {
    update(roomRef, { black: null });
  }
  
  currentRoom = null;
  playerColor = null;
  document.getElementById('game-info').style.display = 'none';
}

function drawChessBoard(board, room) {
  const squareSize = 70;
  
  for (let row = 0; row < 8; row++) {
    for (let col = 0; col < 8; col++) {
      const x = col * squareSize;
      const y = row * squareSize;
      
      // Kare rengi
      chessCtx.fillStyle = (row + col) % 2 === 0 ? '#f0d9b5' : '#b58863';
      chessCtx.fillRect(x, y, squareSize, squareSize);
      
      // Se√ßili ta≈ü vurgusu
      if (selectedPiece && selectedPiece.row === row && selectedPiece.col === col) {
        chessCtx.fillStyle = 'rgba(0, 255, 200, 0.3)';
        chessCtx.fillRect(x, y, squareSize, squareSize);
      }
      
      // Olasƒ± hamleler
      if (possibleMoves.some(m => m.row === row && m.col === col)) {
        chessCtx.fillStyle = 'rgba(0, 255, 0, 0.2)';
        chessCtx.fillRect(x, y, squareSize, squareSize);
      }
      
      // Ta≈ülarƒ± √ßiz
      const piece = board[row][col];
      if (piece) {
        chessCtx.font = 'bold 50px Arial';
        chessCtx.fillStyle = piece === piece.toUpperCase() ? 'white' : 'black';
        chessCtx.fillText(piece, x + 15, y + 55);
      }
    }
  }
}

function handleChessClick(e) {
  if (!currentRoom || !playerColor) return;
  
  const rect = chessCanvas.getBoundingClientRect();
  const scaleX = chessCanvas.width / rect.width;
  const scaleY = chessCanvas.height / rect.height;
  
  const mouseX = (e.clientX - rect.left) * scaleX;
  const mouseY = (e.clientY - rect.top) * scaleY;
  
  const col = Math.floor(mouseX / 70);
  const row = Math.floor(mouseY / 70);
  
  if (row >= 0 && row < 8 && col >= 0 && col < 8) {
    // Hamle yapma mantƒ±ƒüƒ± buraya gelecek
    // (Ger√ßek satran√ß kurallarƒ± i√ßin chess.js k√ºt√ºphanesi √∂nerilir)
    showNotification('Satran√ß hamleleri ≈üu anda basitle≈ütirilmi≈ü versiyondur');
  }
}

window.closeFullRoomMessage = function() {
  document.getElementById('room-full-message').style.display = 'none';
};

window.onload = function() {
  switchScreen('chat');
}
</script>

</body>
</html>
