<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>7/D Sohbet</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#020617,#0f172a);
  color:white;
  overflow:hidden;
}

/* TOPBAR */
#topbar{
  height:50px;
  background:#0f172a;
  display:flex;
  align-items:center;
  padding:0 15px;
  box-sizing:border-box;
  font-size:20px;
}

#menuBtn{ cursor:pointer; }

/* SIDEBAR */
#sidebar{
  position:fixed;
  top:0;
  left:-230px;
  width:230px;
  height:100%;
  background:#020617;
  transition:.25s;
  padding:10px;
  box-sizing:border-box;
  z-index:5;
}

#sidebar.open{ left:0; }

#sidebar img{
  width:70px;
  height:70px;
  border-radius:50%;
  display:block;
  margin:10px auto;
}

.channel{
  background:#1e293b;
  padding:10px;
  border-radius:10px;
  margin-top:10px;
  cursor:pointer;
  text-align:center;
}

/* ONLINE LIST */
#onlineBox{
  margin-top:15px;
  background:#0f172a;
  border-radius:10px;
  padding:8px;
  font-size:13px;
  max-height:150px;
  overflow:auto;
}

/* CHAT */
#chat{
  position:absolute;
  top:50px;
  bottom:70px;
  left:0;
  right:0;
  overflow-y:auto;
  padding:10px;
  box-sizing:border-box;
  scroll-behavior:smooth;
}

.msg{
  background:#1e293b;
  padding:8px;
  border-radius:10px;
  margin:6px 0;
  display:flex;
  gap:8px;
  align-items:flex-start;
  animation:pop .15s ease-out;
}

@keyframes pop{
  from{ transform:scale(.95); opacity:.5; }
  to{ transform:scale(1); opacity:1; }
}

.avatar{
  width:32px;
  height:32px;
  border-radius:50%;
  cursor:pointer;
}

.photo{
  max-width:160px;
  border-radius:10px;
  display:block;
  margin-top:5px;
}

/* INPUT */
#inputArea{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:#020617;
  padding:10px;
  display:flex;
  gap:6px;
  box-sizing:border-box;
}

#msgInput{
  flex:1;
  padding:10px;
  border-radius:10px;
  border:none;
}

button{
  padding:10px 12px;
  border:none;
  border-radius:10px;
  background:#38bdf8;
  cursor:pointer;
}

/* LOGIN */
.panel{
  position:fixed;
  inset:0;
  background:black;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10;
}

.card{
  background:#0f172a;
  padding:20px;
  border-radius:14px;
  width:320px;
  text-align:center;
}

.card input{ width:100%; margin-top:10px; padding:10px; }

/* TYPING */
#typing{
  position:fixed;
  bottom:75px;
  left:10px;
  font-size:13px;
  opacity:.7;
}
audio{ display:none; }
</style>
</head>

<body>

<div id="loginPanel" class="panel">
  <div class="card">
    <h3>7/D GiriÅŸ</h3>
    <input id="nameInput" placeholder="KullanÄ±cÄ± adÄ±">
    <input type="file" id="pfpInput" accept="image/*">
    <button onclick="enter()">GiriÅŸ Yap</button>
  </div>
</div>

<div id="topbar">
  <div id="menuBtn">â˜°</div>
  <div style="margin-left:12px;">ðŸŒ¸ 7/D Sohbet</div>
</div>

<div id="sidebar">
  <img id="myAvatar">
  <div class="channel" onclick="switchRoom('main')">Main</div>
  <div class="channel" onclick="switchRoom('bilgi')">Bilgi</div>
  <div class="channel" onclick="switchRoom('operator')">OperatÃ¶r</div>

  <div id="onlineBox"><b>Online</b><div id="onlineList"></div></div>
</div>

<div id="chat"></div>
<div id="typing"></div>

<div id="inputArea">
  <input id="msgInput" placeholder="Mesaj">
  <input type="file" id="photoInput" accept="image/*">
  <button onclick="record()">ðŸŽ¤</button>
  <button onclick="send()">GÃ¶nder</button>
</div>

<audio id="ping">
  <source src="TT.m4a" type="audio/mp4">
</audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, set, onDisconnect, remove, onValue }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const app = initializeApp({
  apiKey:"AIzaSyAhypFdqgpSmrWRj7a0tFFMJkVdb9L0WxQ",
  databaseURL:"https://sovus-1a29f-default-rtdb.firebaseio.com/",
  projectId:"sovus-1a29f"
});

const db = getDatabase(app);

let username="", avatar="", room="main";
let deviceId = localStorage.getItem("deviceId");

if(!deviceId){
  deviceId=Math.random().toString(36).slice(2);
  localStorage.setItem("deviceId",deviceId);
}

/* LOGIN */
window.enter = () => {
  if(!nameInput.value.trim()) return alert("Ä°sim gir");

  username=nameInput.value;

  const file=pfpInput.files[0];

  if(file){
    const r=new FileReader();
    r.onload=()=>{ avatar=r.result; start(); };
    r.readAsDataURL(file);
  } else {
    avatar="https://ui-avatars.com/api/?name="+username;
    start();
  }
};

function start(){
  loginPanel.style.display="none";
  myAvatar.src=avatar;

  const onlineRef = ref(db,"online/"+deviceId);

  set(onlineRef,{ name:username });
  onDisconnect(onlineRef).remove();

  trackOnline();
  listen();
}

/* MENU */
menuBtn.onclick=()=>sidebar.classList.toggle("open");
chat.onclick=()=>sidebar.classList.remove("open");

/* ONLINE USERS */
function trackOnline(){
  onValue(ref(db,"online"), snap=>{
    onlineList.innerHTML="";
    snap.forEach(c=>{
      const d=document.createElement("div");
      d.textContent="â€¢ "+c.val().name;
      onlineList.appendChild(d);
    });
  });
}

/* ROOMS */
window.switchRoom = r => {
  room=r;
  chat.innerHTML="";
  listen();
};

/* LISTEN */
function listen(){
  onChildAdded(ref(db,"rooms/"+room), snap=>{
    const d=snap.val();

    const div=document.createElement("div");
    div.className="msg";

    const img=document.createElement("img");
    img.src=d.avatar;
    img.className="avatar";

    const content=document.createElement("div");
    content.innerHTML="<b>"+d.name+":</b> "+(d.text||"");

    if(d.photo){
      const p=document.createElement("img");
      p.src=d.photo;
      p.className="photo";
      content.appendChild(p);
    }

    if(d.voice){
      const a=document.createElement("audio");
      a.controls=true;
      a.src=d.voice;
      content.appendChild(a);
    }

    /* DELETE OWN MSG */
    if(d.deviceId===deviceId){
      const del=document.createElement("span");
      del.textContent=" ðŸ—‘";
      del.style.cursor="pointer";
      del.onclick=()=>remove(snap.ref);
      content.appendChild(del);
    }

    div.append(img,content);
    chat.appendChild(div);
    chat.scrollTop=chat.scrollHeight;

    ping.play();
  });
}

/* SEND */
window.send = () => {
  if(photoInput.files[0]){
    const r=new FileReader();
    r.onload=()=> push(ref(db,"rooms/"+room),{
      name:username, avatar, photo:r.result, deviceId
    });
    r.readAsDataURL(photoInput.files[0]);
    photoInput.value="";
    return;
  }

  if(!msgInput.value.trim()) return;

  push(ref(db,"rooms/"+room),{
    name:username,
    avatar,
    text:msgInput.value,
    deviceId
  });

  msgInput.value="";
};

/* TYPING EFFECT */
let typingTimer;

msgInput.oninput=()=>{
  typing.textContent=username+" yazÄ±yor...";
  clearTimeout(typingTimer);
  typingTimer=setTimeout(()=>typing.textContent="",800);
};

/* VOICE */
let rec, chunks=[];

window.record = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  rec=new MediaRecorder(stream);

  rec.ondataavailable=e=>chunks.push(e.data);

  rec.onstop=()=>{
    const blob=new Blob(chunks);
    const r=new FileReader();
    r.onload=()=> push(ref(db,"rooms/"+room),{
      name:username,
      avatar,
      voice:r.result,
      text:"Sesli Mesaj",
      deviceId
    });
    r.readAsDataURL(blob);
    chunks=[];
  };

  rec.start();
  setTimeout(()=>rec.stop(),60000);
};

msgInput.addEventListener("keypress", e=>{
  if(e.key==="Enter") send();
});
</script>

</body>
</html>
