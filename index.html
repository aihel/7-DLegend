<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>7/D Sohbet</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#0f172a;
  color:white;
  overflow:hidden;
}

#topbar{
  height:50px;
  background:#020617;
  display:flex;
  align-items:center;
  padding:0 15px;
}

#menuBtn{ cursor:pointer; font-size:22px; }

#sidebar{
  position:fixed;
  top:0;
  left:-230px;
  width:230px;
  height:100%;
  background:#020617;
  transition:.2s;
  padding:10px;
  box-sizing:border-box;
  z-index:5;
}

#sidebar.open{ left:0; }

.channel{
  background:#1e293b;
  padding:10px;
  border-radius:10px;
  margin-top:10px;
  cursor:pointer;
  text-align:center;
}

#chat{
  position:absolute;
  top:50px;
  bottom:80px;
  left:0;
  right:0;
  overflow-y:auto;
  padding:10px;
}

.msg{
  padding:8px;
  border-radius:10px;
  margin:5px 0;
  background:#1e293b;
}

.admin{ background:#dc2626; }
.kidemli{ background:#ec4899; }

.avatar{
  width:28px;
  height:28px;
  border-radius:50%;
  vertical-align:middle;
  margin-right:6px;
  cursor:pointer;
}

#inputArea{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:#020617;
  padding:10px;
  display:flex;
  gap:6px;
}

input{ padding:10px; border-radius:10px; border:none; }

button{
  padding:10px;
  border:none;
  border-radius:10px;
  background:#38bdf8;
  cursor:pointer;
  color:white;
}

#recBtn{ background:#22c55e; }

#trash{
  position:fixed;
  bottom:90px;
  right:20px;
  font-size:32px;
  display:none;
}

.panel{
  position:fixed;
  inset:0;
  background:black;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10;
}

.card{
  background:#020617;
  padding:20px;
  border-radius:14px;
  width:300px;
  text-align:center;
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPanel" class="panel">
  <div class="card">
    <h3>7/D GiriÅŸ</h3>

    <input id="nameInput" placeholder="KullanÄ±cÄ± adÄ±"><br><br>
    <input id="codeInput" placeholder="GiriÅŸ kodu"><br><br>

    <input type="file" id="pfpInput" accept="image/*"><br><br>

    <label>
      <input type="checkbox" id="rememberMe"> Beni HatÄ±rla
    </label><br><br>

    <button onclick="enter()">GiriÅŸ Yap</button>
  </div>
</div>

<!-- TOPBAR -->
<div id="topbar">
  <div id="menuBtn">â˜°</div>
  <div style="margin-left:10px;">7/D Sohbet</div>
</div>

<!-- SIDEBAR -->
<div id="sidebar">
  <div class="channel" onclick="switchRoom('main')">Main</div>
  <div class="channel" onclick="switchRoom('bilgi')">Bilgi</div>
  <div class="channel" onclick="switchRoom('banlist')">Banlananlar</div>
</div>

<!-- CHAT -->
<div id="chat"></div>

<!-- INPUT -->
<div id="inputArea">
  <input id="msgInput" placeholder="Mesaj" style="flex:1;">
  <button id="recBtn">ðŸŽ¤</button>
  <button onclick="send()">GÃ¶nder</button>
</div>

<div id="trash">ðŸ—‘</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, push, onChildAdded, set }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

/* FIREBASE */
const app = initializeApp({
  apiKey:"AIzaSyAhypFdqgpSmrWRj7a0tFFMJkVdb9L0WxQ",
  databaseURL:"https://sovus-1a29f-default-rtdb.firebaseio.com/",
  projectId:"sovus-1a29f"
});

const db = getDatabase(app);

/* DEVICE ID */
const DEVICE_ID = localStorage.getItem("deviceId") || Math.random().toString(36);
localStorage.setItem("deviceId", DEVICE_ID);

/* GLOBAL */
let username="", role="user", room="main", mutedUntil=0, avatar="";

/* KODLAR */
const CODES = {
  "kmja":"user",
  "Alex":"kidemli",
  "deop":"admin"
};

/* BENÄ° HATIRLA */
const savedUser = localStorage.getItem("userData");

if(savedUser){
  const u = JSON.parse(savedUser);
  username = u.name;
  role = u.role;
  avatar = u.avatar;

  loginPanel.style.display="none";
  listen();
}

/* BAN CHECK */
onChildAdded(ref(db,"bans"), snap=>{
  if(snap.key === DEVICE_ID){
    document.body.innerHTML="<h1>BANLANDIN</h1>";
  }
});

/* LOGIN */
window.enter = () => {

  const name = nameInput.value.trim();
  const code = codeInput.value.trim();
  const remember = rememberMe.checked;

  if(!name || !CODES[code]) return alert("Bilgiler hatalÄ±");

  username = name;
  role = CODES[code];

  const file = pfpInput.files[0];

  if(file){
    const reader = new FileReader();
    reader.onload = () => {
      avatar = reader.result;
      finishLogin(remember);
    };
    reader.readAsDataURL(file);
  } else {
    avatar = "https://ui-avatars.com/api/?name="+username;
    finishLogin(remember);
  }
};

function finishLogin(remember){
  loginPanel.style.display="none";

  if(remember){
    localStorage.setItem("userData", JSON.stringify({
      name: username,
      role: role,
      avatar: avatar
    }));
  }

  listen();
}

menuBtn.onclick=()=>sidebar.classList.toggle("open");
chat.onclick=()=>sidebar.classList.remove("open");

window.switchRoom = r => {
  room=r;
  chat.innerHTML="";
  listen();
};

/* MESAJLARI DÄ°NLE */
function listen(){
  onChildAdded(ref(db,"rooms/"+room), snap=>{
    const d=snap.val();

    const div=document.createElement("div");
    div.className="msg";

    if(d.role==="admin") div.classList.add("admin");
    if(d.role==="kidemli") div.classList.add("kidemli");

    div.innerHTML = `<img src="${d.avatar}" class="avatar"> <b>${d.name}:</b> ${d.text}`;

    if(d.voice){
      const a=document.createElement("audio");
      a.controls=true;
      a.src=d.voice;
      div.appendChild(a);
    }

    if(role==="admin" && room!=="banlist"){
      const banBtn=document.createElement("button");
      banBtn.textContent="Ban";
      banBtn.onclick=()=> set(ref(db,"bans/"+d.deviceId),true);

      const muteBtn=document.createElement("button");
      muteBtn.textContent="Mute";
      muteBtn.onclick=()=> push(ref(db,"mutes"),{
        deviceId:d.deviceId,
        until:Date.now()+600000
      });

      div.append(banBtn,muteBtn);
    }

    chat.appendChild(div);
    chat.scrollTop=chat.scrollHeight;
  });

  onChildAdded(ref(db,"mutes"), snap=>{
    const m=snap.val();
    if(m.deviceId===DEVICE_ID) mutedUntil=m.until;
  });
}

/* MESAJ GÃ–NDER */
window.send = () => {
  if(Date.now() < mutedUntil) return alert("Susturuldun");
  if(!msgInput.value.trim()) return;

  push(ref(db,"rooms/"+room),{
    name:username,
    text:msgInput.value,
    role,
    avatar,
    deviceId:DEVICE_ID
  });

  msgInput.value="";
};

msgInput.addEventListener("keypress", e=>{
  if(e.key==="Enter") send();
});

/* SESLÄ° MESAJ */
let mediaRecorder, audioChunks=[], cancelVoice=false;

const recBtn = document.getElementById("recBtn");
const trash = document.getElementById("trash");

recBtn.onmousedown = startRec;
recBtn.ontouchstart = startRec;

recBtn.onmouseup = stopRec;
recBtn.ontouchend = stopRec;

function startRec(){
  cancelVoice=false;
  trash.style.display="block";

  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    mediaRecorder = new MediaRecorder(stream);
    audioChunks=[];

    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

    mediaRecorder.onstop = () => {
      trash.style.display="none";

      if(cancelVoice) return;

      const blob=new Blob(audioChunks);
      const reader=new FileReader();

      reader.onloadend=()=> push(ref(db,"rooms/"+room),{
        name:username,
        text:"Sesli Mesaj",
        voice:reader.result,
        role,
        avatar,
        deviceId:DEVICE_ID
      });

      reader.readAsDataURL(blob);
    };

    mediaRecorder.start();

    setTimeout(()=>{
      if(mediaRecorder.state==="recording") mediaRecorder.stop();
    },20000);
  });
}

function stopRec(){
  if(mediaRecorder && mediaRecorder.state==="recording"){
    mediaRecorder.stop();
  }
}

trash.onclick = () => {
  cancelVoice=true;
  trash.style.display="none";

  if(mediaRecorder && mediaRecorder.state==="recording"){
    mediaRecorder.stop();
  }
};
</script>

</body>
</html>
